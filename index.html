<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kak Ira Wedding RSVP</title>
  <meta name="description" content="RSVP for Noor Khairani's Wedding" />
  <meta name="theme-color" content="#fff7ec" />
  <!-- Force light colors even in OS dark mode -->
  <meta name="color-scheme" content="light" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#d4af37;
      --gold-strong:#b89017;
      --gold-soft:#fff0c9;
      --gold-soft-2:#f6e7b8;
      --cream:#fff7ec;
      --white:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;

      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --shadow-sm:0 6px 16px rgba(0,0,0,.08);

      --wallpaper:url('rsvpwallpaper_web.png');

      --hero-overlay-color: 255,247,236;
      --hero-overlay-1: .35;
      --hero-overlay-2: .50;
      --hero-overlay-3: .65;

      /* (TABS OFFSET) Move top buttons up/down */
      --controls-top-offset: 5px;

      /* (HERO OFFSET) Push hero content down so tagline isn't covered by top buttons */
      --hero-top-safe: 25px;

      /* (1) MOBILE LOGO SIZE VARIABLE */
      --mobile-logo-max-height: 92px;

      /* (2) ARROW BOUNCE SPEED VARIABLE */
      --arrow-bounce-duration: 1.3s;

      /* Name position offsets (working & stackable with z) */
      --name1-offset-x: 0px;   /* +ve = right, -ve = left */
      --name1-offset-y: 10px;  /* +ve = down,  -ve = up   */
      --name2-offset-x: -15px;   /* +ve = right, -ve = left */
      --name2-offset-y: -65px; /* +ve = down,  -ve = up   */

      /* Layer control so heart/name can overlap */
      --name1-z: 2;
      --heart-z: 1;
      --name2-z: 2;

      /* NEW: hero heart image controls */
      --hero-heart-width: 1.45em;
      --hero-heart-offset-x: 15px;  /* +ve = right, -ve = left */
      --hero-heart-offset-y: -30px; /* +ve = down,  -ve = up   */

      /* NEW: top buttons sizing */
      --top-btn-height: 28px;
      --top-btn-min-width: 36px;
      --top-btn-padding-x: 8px;

      /* Arrow vertical offset (distance from bottom of the hero) */
      --arrow-bottom-offset: 3px;

      /* NEW: fine position controls for ALL hero items (like name1/name2) */
      --hero-tag-offset-x: 0px;     /* +ve = right, -ve = left */
      --hero-tag-offset-y: 15px;     /* +ve = down,  -ve = up   */
      --hero-date-offset-x: 0px;    /* +ve = right, -ve = left */
      --hero-date-offset-y: -58px;    /* +ve = down,  -ve = up   */
      --hero-address-offset-x: 0px; /* +ve = right, -ve = left */
      --hero-address-offset-y: -60px; /* +ve = down,  -ve = up   */
      --hero-logo-offset-x: 0px;    /* +ve = right, -ve = left */
      --hero-logo-offset-y: 0px;    /* +ve = down,  -ve = up   */
      --hero-arrow-offset-x: 0px;   /* +ve = right, -ve = left */
      --hero-arrow-offset-y: 30px;   /* +ve = away from bottom (adds), -ve = closer to bottom */

      /* Parents spacing */
      --parentsA-gap: 3px;
      --parentsB-gap: 3px;

      /* Label font controls */
      --inv-label-size: 13px;
      --inv-label-color: #6b4b00;

      /* Consistent section spacing */
      --section-space: 20px;

      /* Smaller size for four parent names */
      --parent-name-size: clamp(19px, 4.2vw, 22px);

      /* Tighten letter-spacing for invite body */
      --inv-body-letter-spacing: .04em;

      /* ===== NEW (Schedule group nudge) ===== */
      --sched-group-x: 0px;  /* +right, -left  */
      --sched-group-y: 0px;  /* +down,  -up    */

      /* Force light UI widgets even in dark mode */
      color-scheme: light;
    }

    @media (orientation: portrait){
      :root{ --wallpaper:url('rsvpwallpaper_mob.png'); }
    }
    @media (orientation: landscape){
      :root{ --wallpaper:url('rsvpwallpaper_web.png'); }
    }

    /* Extra safeguard: keep colors the same even if system prefers dark */
    @media (prefers-color-scheme: dark){
      html, body { background: var(--cream) !important; color: var(--text) !important; }
      .card, .btn, .input, .confirm-btn { background:#fff !important; color:#111 !important; }
    }

    *{ box-sizing:border-box }
    html{ scroll-behavior:auto }
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--cream);
    }

    /* Default font for many headings (but we'll override hero date below) */
    h1,h2,h3,h4,h5,h6,
    .heading,
    .section-title,
    .agenda-date,
    .tl-title,
    .inv-label,
    .inv-couple,
    .hero .tagline,
    .cd-num{
      font-family:"Times New Roman", Times, serif;
    }

    #bg-particles{ position:fixed; inset:0; z-index:9; pointer-events:none; opacity:.45; }

    .top-controls,
    .hero .heading,
    .hero .sub,
    .cta-row,
    .card,
    .footer { position:relative; z-index:10; }

    /* Top-centered controls */
    .top-controls{
      position: fixed;
      left: 50%;
      top: var(--controls-top-offset);
      transform: translateX(-50%);
      display: flex;
      flex-direction: row;
      gap: 8px;
      z-index: 9999;
    }
    .icon-btn{
      appearance:none; cursor:pointer;
      background:#fff; color:#5a3d00;
      border:1px solid rgba(0,0,0,.08);
      height: var(--top-btn-height);
      min-width: var(--top-btn-min-width);
      padding: 0 var(--top-btn-padding-x);
      font-size:10px; font-weight:600;
      border-radius:12px;
      box-shadow:none;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .icon-btn.icon-only{
      width: var(--top-btn-height);
      height: var(--top-btn-height);
      padding:0;
    }
    .icon-btn:hover{ transform:none; box-shadow:none; }
    .icon-btn:active{ transform:none; }

    .volume-pop{ display:none !important; }

	/* Hide the Photos/Gambar top button */
	#quickPhotos { display:none !important; }

    /* Hero */
    .hero{
      position:relative;
      min-height:100svh;
      display:grid; place-items:center; text-align:center; color:#222;

      background-image:
        linear-gradient(
          180deg,
          rgba(var(--hero-overlay-color), var(--hero-overlay-1)) 0%,
          rgba(var(--hero-overlay-color), var(--hero-overlay-2)) 55%,
          rgba(var(--hero-overlay-color), var(--hero-overlay-3)) 100%
        ),
        var(--wallpaper);
      background-position: center center, center center;
      background-repeat: no-repeat, no-repeat;
      background-size: cover, cover;
      background-attachment: scroll, scroll;
    }

    /* Push hero content down by variable to avoid overlap with top buttons */
    .hero > div{ padding-top: var(--hero-top-safe); }

    /* Scroll arrow (uses adjustable offsets) */
    .hero-scroll{
      position:absolute;
      left: calc(50% + var(--hero-arrow-offset-x));
      bottom: calc(var(--arrow-bottom-offset) + var(--hero-arrow-offset-y));
      transform: translateX(-50%);
      width:56px; height:56px; border-radius:999px;
      background:transparent; border:0; color:var(--gold-strong);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow:none;
      animation:soft-bounce var(--arrow-bounce-duration) infinite ease-in-out;
      padding:6px;
    }
    .hero-scroll svg{ width:100%; height:100%; }
    .hero-scroll:active{ transform:translateX(-50%) scale(0.98); }
    @keyframes soft-bounce{
      0%,100%{ transform:translateX(-50%) translateY(0); }
      50%    { transform:translateX(-50%) translateY(-6px); }
    }

    .hero .tagline{
      font-size:16px;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:#6b4b00;
      margin-bottom:28px;
      transform: translate(var(--hero-tag-offset-x), var(--hero-tag-offset-y));
    }

    .couple-title{
      display:flex; flex-direction:column; /* Force 3 lines on web too */
      align-items:center; justify-content:center; gap:18px;
      margin-bottom:28px;
      font-family:'Great Vibes', cursive;
      font-weight:400;
      font-size:clamp(75px,12vw,125px);
      line-height:1;
      color:var(--gold-strong);
      text-shadow:0 2px 0 rgba(0,0,0,.04), 0 8px 22px rgba(212,175,55,.25);
      position:relative;
    }
    .couple-title .name{
      display:inline-block;
      position: relative;
      z-index: 1; /* default; overridden by vars below */
    }
    .couple-title .n1{
      transform: translate(var(--name1-offset-x), var(--name1-offset-y));
      z-index: var(--name1-z);
    }
    .couple-title .n2{
      transform: translate(var(--name2-offset-x), var(--name2-offset-y));
      z-index: var(--name2-z);
    }

    /* NEW: PNG heart between names (offset & z controllable) */
    .couple-title .hero-heart{
      width: var(--hero-heart-width);
      height: auto;
      display:inline-block;
      transform: translate(var(--hero-heart-offset-x), var(--hero-heart-offset-y));
      position: relative;
      z-index: var(--heart-z);
    }

    @media (max-width:520px){
      .couple-title{ gap:20px; }
    }

    /* (1) Date font should match address font, keep size */
    .hero-date{
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif !important;
      font-size:clamp(16px,4vw,22px);
      letter-spacing:.02em;
      color:#5b5b5b;
      margin-bottom:36px;
      transform: translate(var(--hero-date-offset-x), var(--hero-date-offset-y));
    }

    /* LOGO + ADDRESS grouped */
    .hero-address-wrap{
      max-width:900px;
      margin:0 auto 36px;
      padding:0 12px;
      display:flex; align-items:center; justify-content:center; gap:16px;
      flex-wrap:nowrap;
      transform: translate(var(--hero-address-offset-x), var(--hero-address-offset-y));
    }
    .hero-address{
      max-width:720px;
      font-size:clamp(13px,3.2vw,16px);
      line-height:1.45;
      color:#5b5b5b;
      text-align:left;
      margin:0;
    }
    .hero-logo{
      display:block;
      height:auto;
      max-height:160px;
      width:auto; object-fit:contain;
      flex:0 0 auto;
      transform: translate(var(--hero-logo-offset-x), var(--hero-logo-offset-y));
    }
    @media (max-width:560px){
      .hero-address-wrap{
        gap:12px; padding:0 10px;
        flex-direction:column; align-items:center; text-align:center;
      }
      .hero-logo{ max-height:var(--mobile-logo-max-height); max-width:60vw; }
      .hero-address{ text-align:center; }
    }

    .heading{ font-size:clamp(28px,5vw,52px); line-height:1.12; }
    .sub{ color:var(--muted); margin-top:8px }

    .cta-row{ margin-top:26px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    .btn{
      appearance:none; cursor:pointer; display:inline-block; text-decoration:none;
      padding:14px 22px; border-radius:var(--radius);
      background:#fff; color:#111; font-weight:600; letter-spacing:.3px;
      border:1px solid var(--gold-strong);
      box-shadow:var(--shadow-sm);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:16px;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }
    .btn:active{ transform:translateY(0); }
    .btn-outline{ background:#fff; color:#111; border:1px solid var(--gold-strong) }

    /* (5) Ensure gold-filled submit when enabled; grey when disabled/submitted */
    button#submitBtn{ background:var(--gold) !important; color:#111 !important; border:1px solid var(--gold-strong) !important; }
    #submitBtn[disabled]{ background:#eee !important; color:#999 !important; border-color:#ddd !important; cursor:not-allowed; box-shadow:none; transform:none; }

    .btn.disabled,
    .btn[aria-disabled="true"]{
      background:#eee !important; color:#999 !important; border-color:#ddd !important;
      pointer-events:none; box-shadow:none; transform:none;
    }

    section{ padding: var(--section-space) 16px; background:transparent; }
    .container{ max-width:980px; margin:0 auto; }
    .card{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:var(--radius); box-shadow:var(--shadow); padding:22px; }

    .grid{ display:grid; gap:14px; grid-template-columns:1fr; }
    .row{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }

    .input{
      width:100%; height:48px; padding:0 16px; border-radius:12px;
      border:1px solid #e5e7eb; font-size:16px; background:#fff;
      transition:border-color .12s ease, box-shadow .12s ease, background .12s ease;
      outline:none;
    }
    .input::placeholder{ color:#c8c8c8; opacity:1; }
    .input:focus:not([readonly]){ border-color:var(--gold-strong); box-shadow:0 0 0 3px rgba(212,175,55,.20); }
    .input[readonly]{ background:#fffdf7; border-color:#ead79a; color:#6b4b00; }

    .tiny{ font-size:12px; color:#6b7280 }
    .total{ text-align:center; margin-top:6px; color:#374151 }

    .confirm-btn{
      height:48px; padding:0 16px;
      white-space:nowrap; border-radius:12px;
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--gold-strong);
      box-shadow:var(--shadow-sm);
      transition:opacity .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
      cursor:pointer;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .confirm-btn.confirm-state{ background:var(--gold-soft); color:#111; }
    .confirm-btn.edit-state{ background:#fff; color:#111; }
    .confirm-btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .submit-wrap{ display:flex; flex-direction:column; gap:12px; }

    .notice{
      background:#fff; border:1px solid #fde68a;
      padding:12px 14px; border-radius:12px; color:#92400e;
      box-shadow:var(--shadow-sm);
    }
    .muted{ color:#6b7280 }

    .section-title{ margin:0 0 8px; font-size:clamp(22px,3.6vw,28px); color:#1f2937; }

    .separator{ height:1px; margin:18px 0; background:linear-gradient(90deg, transparent, rgba(184,144,23,.35), transparent); }
    .spacer-8{ height:8px }
    .spacer-16{ height:16px }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; }
    .footer{ text-align:center; color:#6b7280; padding:30px 16px 70px; background:transparent; }

    .brandline{
      display:inline-flex;
      align-items:baseline;
      gap:8px;
      color:#c9c3b9;
      letter-spacing:.18em;
      text-transform:lowercase;
      font-size:14px;
    }
    .brandline .brand-link{
      letter-spacing:.04em;
      text-transform:uppercase;
      color:#c9c3b9;
      text-decoration:none;
      transition:color .15s ease, transform .15s ease;
      line-height:1;
    }
    .brandline .brand-strong{ font-weight:800; }
    .brandline .brand-light{ font-weight:300; }
    .brandline .brand-link:hover{ color:var(--gold-strong); }

    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#111; color:#fff; padding:12px 16px; border-radius:12px;
      opacity:0; pointer-events:none; transition:.25s ease; box-shadow:0 8px 24px rgba(0,0,0,.3)
    }
    .toast.show{ opacity:1 }

    /* COUNTDOWN — always one line, softer gold */
    #countdown .cd-sub{ margin:6px 0 16px; }
    .countdown-row{
      display:flex; gap:12px; align-items:stretch; justify-content:stretch;
      flex-wrap:nowrap;
    }
    .cd-box{
      background:
        radial-gradient(circle at 50% 45%,
          rgba(255,253,245,.88) 0%,
          rgba(255,245,215,.70) 38%,
          rgba(248,229,160,.52) 62%,
          rgba(232,202,110,.48) 82%,
          rgba(212,175,55,.55) 100%);
      border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius);
      box-shadow:var(--shadow-sm); padding:16px 12px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; aspect-ratio:1/1; min-width:0;
      flex: 1 1 0;
    }
    .cd-num{ font-weight:700; line-height:1; font-size:clamp(22px, 7.2vw, 48px); }
    .cd-label{ margin-top:6px; font-size:12px; letter-spacing:.35em; color:#6b7280; }

    /* AGENDA */
    .agenda{ display:grid; grid-template-columns: 240px 1fr; gap:24px; --timeline-pad:28px; --tl-line-x:11px; --tl-dot-nudge:1px; }
    .agenda-date{ font-size:clamp(18px,2.6vw,24px); }
    .agenda-day{ color:#6b7280; margin-top:6px; }

    .timeline{ position:relative; padding-left:var(--timeline-pad); }
    .timeline::before{ content:''; position:absolute; left:var(--tl-line-x); top:6px; bottom:6px; width:2px; background:var(--gold-strong); }

    .tl-item{ position:relative; display:grid; grid-template-columns: 120px 1fr; align-items:center; gap:10px; margin:20px 0; }
    .tl-mid{ display:none; }

    .tl-item::before{
      content:''; position:absolute;
      left: calc( (var(--tl-line-x) - var(--timeline-pad)) + var(--tl-dot-nudge) );
      top:50%;
      width:14px; height:14px; border-radius:50%;
      background:var(--gold-strong);
      transform:translate(-50%, -50%);
      box-shadow:0 0 0 3px var(--gold-soft);
    }

    .tl-time{ font-weight:600; color:#0f172a; }
    .tl-what{ color:#0f172a; }
    .tl-title{ font-weight:700; letter-spacing:.02em; }
    .tl-desc{
      margin-top:4px; font-size:12px; line-height:1.35; color:#6b7280;
    }
    /* NEW: bullet styling inside schedule descriptions */
    .tl-desc ul{ list-style: disc; margin:6px 0 0 18px; padding:0; }
    .tl-desc li{ margin:2px 0; }

    @media (max-width:700px){
      .agenda{ grid-template-columns:1fr; }
      .tl-item{ grid-template-columns: 96px 1fr; }
    }

    /* Invitation card frame */
    .invite-card{ position:relative; background:#fff; border-radius:28px; padding:36px 24px; box-shadow:var(--shadow); border:1px solid rgba(184,144,23,.30); overflow:hidden; }
    .invite-card::before,
    .invite-card::after{
      content:''; position:absolute; pointer-events:none; width:320px; height:320px; opacity:.18; filter:blur(0.2px);
      background:
        radial-gradient( circle at 30% 30%, rgba(212,175,55,.9), rgba(212,175,55,0) 60% ),
        radial-gradient( circle at 70% 70%, rgba(255,255,255,.9), rgba(255,255,255,0) 65% );
    }
    .invite-card::before{ top:-120px; left:-120px; transform:rotate(-12deg); }
    .invite-card::after{ bottom:-120px; right:-120px; transform:rotate(18deg); }

    .invite-inner{
      position:relative; padding:28px 18px; border-radius:20px;
      background:
        linear-gradient(#fff,#fff) padding-box,
        linear-gradient(135deg, rgba(255,255,255,.7), rgba(212,175,55,.9), rgba(255,255,255,.7)) border-box;
      border:2px solid transparent;
      text-align:center;
    }

    .inv-small{ text-align:center; font-size:13px; letter-spacing:.18em; text-transform:uppercase; color:#6b4b00; }
    .inv-body-fixed{ }
    .inv-couple{ margin:18px 0 10px; text-align:center; font-weight:700; font-size:clamp(22px,4.8vw,34px); color:#111; }

    .parents-block .inv-couple{ font-size: var(--parent-name-size); }
    #invBody{ letter-spacing: var(--inv-body-letter-spacing); }

    .parents-block .inv-couple{ margin: var(--pair-gap, 6px) 0; }
    .parents-block .inv-and{ margin: var(--pair-gap, 6px) 0; }
    .parents-a{ --pair-gap: var(--parentsA-gap); }
    .parents-b{ --pair-gap: var(--parentsB-gap); }

    .inv-details{ max-width:720px; margin:20px auto 0; display:grid; gap:14px; }
    .inv-row{ text-align:center; }

    .inv-label{
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-weight:700;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--inv-label-color);
      font-size:var(--inv-label-size);
    }
    .inv-value{ margin-top:4px; color:#0f172a; }

    .loc-photo{
      display:block;
      margin:12px auto 12px;
      max-width:100%;
      height:auto;
      border-radius:12px;
      box-shadow:var(--shadow-sm);
    }

    .location-card{ text-align:center; display:flex; flex-direction:column; align-items:center; }
    .location-card .actions{ justify-content:center; }
    .location-card p{ text-align:center; }
    .location-card .section-title{ align-self:flex-start; text-align:left; }

    #locNote{ display:none; }

    #noMsg{ text-align:center; margin-top:16px; display:none; }

    #cta .btn{ text-transform:none; font-weight:600; }

    .invite-inner #invSmall{ display:block; text-align:center; }

    /* NEW: spacing tweaks requested for Invitation section */
    .invite-inner .inv-label + .parents-a{ margin-top:10px; }   /* space between "WalimatulUrus" and first parent name */
    .parents-a{ margin-bottom:10px; }                           /* a bit more space below Samsah block */
    .parents-b{ margin-top:10px; }                              /* space before Noor Khairani block */

    /* NEW: Contact list layout */
    .contact-list{ display:grid; gap:10px; }
    .contact-row{
      display:grid; grid-template-columns: 1fr auto; align-items:center;
      gap:12px; padding:12px 14px;
      background:#fff; border:1px solid rgba(0,0,0,.06);
      border-radius:12px; box-shadow:var(--shadow-sm);
    }
    .contact-left{ font-weight:700; color:#0f172a; }
    .contact-right{ display:flex; align-items:center; gap:10px; color:#6b7280; }

    /* (4) Phone icon button: use PNG directly, no frame */
    .call-btn{
      width:36px; height:36px;
      display:inline-flex; align-items:center; justify-content:center;
      background:transparent; border:0; box-shadow:none; border-radius:0;
      text-decoration:none; padding:0;
    }
    .call-btn img{ width:100%; height:100%; object-fit:contain; display:block; }

    /* (6) LIVE PHOTO gallery */
    .live-gallery{
      display:flex; align-items:center; justify-content:center; gap:12px;
      margin-top:8px;
    }
    .live-gallery img{
      max-width:100%; max-height:420px; border-radius:12px; box-shadow:var(--shadow-sm);
    }

    /* (1) make the small location description respect line breaks */
    #locSmall, #subtitleText { white-space: pre-line; }

    /* (1) ensure the location small text is left-aligned beneath the title */
    #locSmall{ align-self:flex-start; text-align:left !important; }

    /* (1) centered hotel label under the photo */
    .loc-hotel{ text-align:center; font-weight:600; margin-top:4px; }

    /* ===== (2) Country code selector styles ===== */
    .phone-row{
      display:grid;
      grid-template-columns: auto 1fr; /* selector + input */
      gap:10px;
      align-items:center;
    }
    .cc-select{
      appearance:none;
      height:48px;
      min-width:68px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid var(--gold-strong);
      background:linear-gradient(180deg, #fffaec, #ffe7b9);
      font-weight:700;
      color:#6b4b00;
      box-shadow:var(--shadow-sm);
      position:relative;
    }
    .cc-select:focus{ outline:none; box-shadow:0 0 0 3px rgba(212,175,55,.20); }
    .cc-wrap{ position:relative; }
    .cc-wrap::after{
      content:'▾';
      position:absolute; right:10px; top:50%;
      transform:translateY(-50%);
      pointer-events:none; color:#6b4b00; font-size:12px;
    }

    /* ====== (1) NEW: Submit loading dots ====== */
    #submitBtn.loading{
      position: relative;
      color: transparent !important;  /* hide label while loading */
      pointer-events: none;
    }
    #submitBtn.loading::after{
      content: "";
      position: absolute;
      top: 50%; left: 50%;
      width: 6px; height: 6px; border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow:
        -16px 0 0 0 #111,
         0    0 0 0 #111,
         16px 0 0 0 #111;
      animation: btnDots 0.9s infinite ease-in-out;
    }
    @keyframes btnDots{
      0%, 80%, 100% { box-shadow: -16px 0 0 0 #111, 0 0 0 0 transparent, 16px 0 0 0 transparent; }
      40%          { box-shadow: -16px 0 0 0 transparent, 0 0 0 0 #111, 16px 0 0 0 transparent; }
      60%          { box-shadow: -16px 0 0 0 transparent, 0 0 0 0 transparent, 16px 0 0 0 #111; }
    }

    /* ====== (2) NEW: Group nudge for schedule line+dots+time ====== */
    .timeline::before{
      transform: translate(var(--sched-group-x), var(--sched-group-y));
    }
    .tl-item::before{
      transform: translate(var(--sched-group-x), var(--sched-group-y)) translate(-50%, -50%);
    }
    .tl-time{
      transform: translate(var(--sched-group-x), var(--sched-group-y));
    }
  </style>
</head>
<body>

  <canvas id="bg-particles" aria-hidden="true"></canvas>

  <div class="top-controls">
    <!-- (NEW ORDER) Home (icon) → Location → Contact → Photos → Mute → Language -->
    <button id="quickHome" class="icon-btn icon-only" aria-label="Go to Home" title="Home">
      <!-- simple home SVG icon -->
      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
        <path d="M3 10.5L12 3l9 7.5v8.5a1 1 0 0 1-1 1h-5.5a.5.5 0 0 1-.5-.5V15a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4.5a.5.5 0 0 1-.5.5H4a1 1 0 0 1-1-1v-8.5z" fill="currentColor"/>
      </svg>
    </button>
    <button id="quickLocation" class="icon-btn" aria-label="Jump to location">Location</button>
    <button id="quickContact"  class="icon-btn" aria-label="Jump to contact">Contact</button>
    <!-- (2) New Photos/Gambar quick button -->
    <button id="quickPhotos"   class="icon-btn" aria-label="Jump to photos">Photos</button>
    <button id="muteBtn" class="icon-btn" aria-label="Toggle sound">🔊</button>
    <button id="langToggle" class="icon-btn" aria-label="Toggle language">Malay</button>
  </div>

  <header class="hero">
    <div>
      <div class="tagline" id="heroTag">Wedding Invitation</div>

      <!-- Names + PNG heart (now offset/z controlled only by CSS variables) -->
      <div class="couple-title" aria-label="Basran love Khairani">
        <span class="name n1" data-text="Basran">Basran</span>
        <img class="hero-heart" src="hero_heart.png" alt="" />
        <span class="name n2" data-text="Khairani">Khairani</span>
      </div>

      <!-- Date with weekday (Poppins font, bigger than address) -->
      <div class="hero-date" id="heroDate">Saturday, 22 November 2025</div>

      <!-- LOGO + ADDRESS -->
      <div class="hero-address-wrap" id="heroAddressWrap">
        <img id="hotelLogo" class="hero-logo" src="promanade_hotel_logo_ai.png" alt="Promenade Hotel Kota Kinabalu logo"/>
        <div class="hero-address" id="heroAddress">
          Rafflesia Ballroom <br/>
          Promenade Hotel, Tingkat 1<br/>
          4, 3, Lorong Api - Api 1,<br/>
          Api-api Centre,<br/>
          88000 Kota Kinabalu, Sabah.
        </div>
      </div>
    </div>

    <!-- Bouncy double-chevron in gold -->
    <button id="scrollArrow" class="hero-scroll" aria-label="Scroll to details" title="Scroll">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path d="M4 7.5 L12 15.5 L20 7.5" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M4 12.5 L12 20.5 L20 12.5" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </header>

  <main>
    <!-- CTA -->
    <section id="cta">
      <div class="container">
        <div class="card" style="text-align:center">
          <div class="heading" id="titleText">Will you attend our wedding?</div>
          <!-- (2) Make small like RSVP description + show new lines -->
          <div class="tiny muted" id="subtitleText">We'd love to celebrate with you.
Please confirm your attendance
before 1 October 2025.</div>
          <div class="cta-row" style="justify-content:center">
            <a class="btn" href="#rsvp" id="rsvpBtn" data-smooth>YES</a>
            <button class="btn btn-outline" id="noBtn" type="button">NO</button>
          </div>
          <div id="noMsg" class="notice tiny">Sila hubungi keluarga pengantin jika berubah fikiran</div>
        </div>
      </div>
    </section>

    <!-- Invitation -->
    <section id="invite">
      <div class="container">
        <div class="invite-card">
          <div class="invite-inner">
            <div class="inv-label" id="invSmall">Undangan Majlis Perkahwinan</div>
            <div class="inv-label" id="invSmall2">WalimatulUrus</div>

            <div class="parents-block parents-a">
              <div class="inv-couple">Muhammad Basri Bin Patara</div>
              <div class="inv-and" style="text-align:center; color:#b89017; font-size:clamp(10px,4.2vw,22px)">&amp;</div>
              <div class="inv-couple">Samsah Binti Suda</div>
            </div>

            <div class="inv-small" id="invBody">
              Dengan penuh rasa kesyukuran, kami menjemput Tuan/Puan/Encik/Cik beserta suami/isteri/pasangan untuk memeriahkan Majlis Perkahwinan puteri kami
            </div>

            <div class="parents-block parents-b">
              <div class="inv-couple">Noor Khairani Binti Muhammad Basri</div>
              <div class="inv-and" style="text-align:center; color:#b89017; font-size:clamp(10px,4.2vw,22px)">&amp;</div>
              <div class="inv-couple">Basran Bin Ab Hamid</div>
            </div>

            <div class="inv-details">
              <div class="inv-row">
                <div class="inv-label" id="invDateLabel">Tarikh</div>
                <div class="inv-value" id="inviteDate">Sabtu, 22 November 2025</div>
              </div>
              <div class="inv-row">
                <div class="inv-label" id="invTimeLabel">Masa</div>
                <div class="inv-value" id="inviteTime">10:00AM – 3:00PM</div>
              </div>
              <div class="inv-row">
                <div class="inv-label" id="invVenueLabel">Tempat</div>
                <div class="inv-value" id="inviteVenue">Promenade Hotel, Rafflesia Ballroom</div>
              </div>
              <div class="inv-row">
                <div class="inv-label" id="invDressLabel">Etika Pakaian</div>
                <div class="inv-value" id="inviteDress">Sopan</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RSVP -->
    <section id="rsvp">
      <div class="container">
        <div class="card">
          <h2 class="section-title" id="rsvpTitle">RSVP</h2>
          <p class="tiny muted" id="rsvpIntro">Kindly share your full name, so we may welcome you with joy on our special day.</p>

          <form id="rsvpForm" method="POST" target="hidden_iframe">
            <input type="hidden" name="guest1" id="post_guest1">
            <input type="hidden" name="guest2" id="post_guest2">
            <input type="hidden" name="guest3" id="post_guest3">
            <input type="hidden" name="guest4" id="post_guest4">
            <input type="hidden" name="lang" id="post_lang" value="en">
            <input type="hidden" name="guestsCount" id="post_count" value="0">
            <input type="hidden" name="ua" id="post_ua">
            <input type="hidden" name="note" id="post_note">

            <div id="guestRows" class="grid" aria-live="polite"></div>

            <div class="separator"></div>
            <div class="spacer-8"></div>

            <div class="submit-wrap">
              <div>
                <h2 class="section-title" id="phoneHeader">PHONE NUMBER</h2>
                <p class="tiny muted" id="phoneHint">We’ll use this to contact you if there are any updates or changes.</p>

                <!-- (2) Country code + phone in a compact row -->
                <div class="phone-row">
                  <div class="cc-wrap">
                    <select id="ccSelect" class="cc-select" aria-label="Country code">
                      <option value="MY">MY</option>
                      <option value="IDN">IDN</option>
                    </select>
                  </div>
                  <input class="input" id="phone" name="phone" autocomplete="tel" placeholder="e.g. +60 12 345 6789" required />
                </div>
              </div>

              <div class="spacer-16"></div>
              <div class="separator"></div>

              <div class="notice tiny" id="validationMsg" style="display:none" aria-live="polite"></div>

              <div class="spacer-8"></div>
              <button class="btn" id="submitBtn" type="submit" disabled>Submit RSVP</button>

              <div class="tiny total" id="totalGuests">Total: 0 guest(s)</div>
            </div>
          </form>
          <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>
        </div>
      </div>
    </section>

    <!-- Schedule -->
    <section id="schedule">
      <div class="container">
        <div class="card">
          <h2 class="section-title" id="scheduleTitle">SCHEDULE</h2>
          <div class="agenda">
            <div>
              <div class="agenda-date" id="agendaDate">November 22, 2025</div>
              <div class="agenda-day tiny" id="agendaDay">Saturday</div>
            </div>
            <div class="timeline">
              <div class="tl-item">
                <div class="tl-time" id="s1Time">10:00am</div>
                <div class="tl-what">
                  <div class="tl-title" id="s1Title">GUEST ARRIVAL</div>
                  <div class="tl-desc" id="s1Desc"></div>
                </div>
              </div>
              <div class="tl-item">
                <div class="tl-time" id="s2Time">11:00am</div>
                <div class="tl-what">
                  <div class="tl-title" id="s2Title">NIKAH</div>
                  <div class="tl-desc" id="s2Desc"></div>
                </div>
              </div>
              <div class="tl-item">
                <div class="tl-time" id="s3Time">12:00pm</div>
                <div class="tl-what">
                  <div class="tl-title" id="s3Title">WEDDING CEREMONY</div>
                  <div class="tl-desc" id="s3Desc"></div>
                </div>
              </div>
              <div class="tl-item">
                <div class="tl-time" id="s4Time">01:00pm</div>
                <div class="tl-what">
                  <div class="tl-title" id="s4Title">LUNCH</div>
                  <div class="tl-title" id="s4Title2" style="margin-top:4px;">PHOTO SESSION</div>
                  <div class="tl-desc" id="s4Desc"></div>
                </div>
              </div>
			  <div class="tl-item">
				<div class="tl-time" id="s5Time">02:00pm</div>
				<div class="tl-what">
					<div class="tl-title" id="s5Title">PHOTO SESSION</div>
					<div class="tl-desc" id="s5Desc"></div>
				</div>
			  </div>
              <div class="tl-item">
                <div class="tl-time" id="s6Time">03:00pm</div>
                <div class="tl-what">
                  <div class="tl-title" id="s6Title">FAREWELL SESSION</div>
                  <div class="tl-desc" id="s6Desc"></div>
                </div>
              </div>

              <div class="tl-mid">•</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Location -->
    <section id="location">
      <div class="container">
        <div class="card location-card">
          <!-- (1) Change title to LOCATION / LOKASI -->
          <h2 class="section-title" id="locTitle">LOCATION</h2>
          <!-- (1) Small description (left-aligned) with clickable coordinates -->
          <p class="tiny muted" id="locSmall">Direction to wedding avenue
(<a id="coordLink" href="#" target="_blank" rel="noopener">5.9752036,116.06877</a>)</p>

          <img id="venuePhoto" class="loc-photo" src="wedding_avenue.jpg" alt="Wedding Avenue location photo" />

          <!-- (1) Centered hotel name under the photo -->
          <div id="locHotel" class="loc-hotel">Promanade Hotel, Kota Kinabalu</div>

          <p class="muted" id="locDesc">Tap the button below to open directions.</p>

          <div class="actions" style="margin:10px 0 18px">
            <a class="btn btn-outline" id="btnWaze" target="_blank" rel="noopener">Waze</a>
            <a class="btn" id="btnGoogleMaps" target="_blank" rel="noopener">Google Maps</a>
          </div>

          <div class="muted tiny" id="locNote">Tip: You can share the link with friends who are carpooling.</div>
        </div>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact">
      <div class="container">
        <div class="card">
          <h2 class="section-title" id="contactTitle">CONTACT (Bride's Family)</h2>
          <p class="muted" id="contactDesc">Tap the phone icon to call.</p>
          <div id="contactList" class="contact-list" style="margin-top:6px"></div>
        </div>
      </div>
    </section>

    <!-- (6) LIVE PHOTO (renamed to PHOTOS/GAMBAR) -->
    <section id="live" hidden>
      <div class="container">
        <div class="card">
          <h2 class="section-title" id="liveTitle">PHOTOS</h2>
          <p class="tiny muted" id="liveHelp">Show a slideshow from a folder named “PHOTOS”.<br/>
• Easiest: put a <code>manifest.json</code> in <code>/PHOTOS</code> that lists image URLs (see code).<br/>
• Or publish a Google Apps Script Web App that returns a JSON array of public image URLs and paste it into <code>DRIVE_WEBAPP_URL</code> in the script.</p>
          <div id="liveGallery" class="live-gallery" aria-live="polite">
            <button id="livePrev" class="icon-btn" type="button" aria-label="Previous photo">‹</button>
            <img id="liveImage" alt="Live photo"/>
            <button id="liveNext" class="icon-btn" type="button" aria-label="Next photo">›</button>
          </div>
          <div class="tiny muted" id="liveEmpty" style="display:none;">No photos yet.</div>
        </div>
      </div>
    </section>

    <!-- Countdown -->
    <section id="countdown">
      <div class="container">
        <div class="card">
          <h2 class="section-title" id="countdownTitle">COUNTDOWN TIMER</h2>
          <p class="muted cd-sub" id="cdSub">Our big day’s coming soon!</p>
          <div class="countdown-row" role="timer" aria-live="polite">
            <div class="cd-box"><div id="cdDays" class="cd-num">0</div><div class="cd-label" id="cdDaysLabel">DAYS</div></div>
            <div class="cd-box"><div id="cdHours" class="cd-num">0</div><div class="cd-label" id="cdHoursLabel">HOURS</div></div>
            <div class="cd-box"><div id="cdMins" class="cd-num">0</div><div class="cd-label" id="cdMinsLabel">MINS</div></div>
            <div class="cd-box"><div id="cdSecs" class="cd-num">0</div><div class="cd-label" id="cdSecsLabel">SECS</div></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="brandline">
      <span>made by</span>
      <!-- (3) Alippu clicks → force Google login then continue to Drive folder -->
      <a href="#" id="alippuLink" class="brand-link">
        <span class="brand-strong">ALIP</span><span class="brand-light">PU</span>
      </a>
    </div>
  </footer>

  <div id="toast" class="toast">Saved!</div>

  <audio id="bgm" src="maulaya.mp3" autoplay preload="auto" playsinline></audio>

  <script>
    // ====== CONFIG ======
    const MAX_GUESTS = 4;
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxbWUzpJp8IH7eIJ4PorTtVFEJK9npyGY8HR6o0HfaNj9_Adin081iRrvof4V_LVMs/exec";

    // Original map button coords (kept)
    const GMAPS_COORDS = { lat: 5.975194, lng: 116.0688396 };
    const WAZE_COORDS  = { lat: 5.975194, lng: 116.0688396 };
    const VENUE_LABEL  = encodeURIComponent("Kak Ira Wedding Venue");

    // (1) Displayed clickable coordinates (as requested)
    const DISPLAY_COORDS = { lat: 5.9752036, lng: 116.06877 };

    // (3) Private Google Drive folder for photos/RSVP tracking
    // Replace the value below with your *restricted* Drive folder link so Google prompts login.
    const DRIVE_PRIVATE_URL = ""; // e.g. "https://drive.google.com/drive/folders/XXXXXXXXXXXX"

    const CONTACTS = [
      { name: "Muhammad Basri", phone: "+60195365338" },
      { name: "Samsah Suda", phone: "+60102517562" },
      { name: "Mohd Ridzuan", phone: "+60134061314" },
    ];

    // Single source of truth for the date/time
    const WEDDING_DATE_ISO = '2025-11-22';
    const WEDDING_TIME = '10:30:00'; // local time for countdown target
    let COUNTDOWN_TARGET = new Date(`${WEDDING_DATE_ISO}T${WEDDING_TIME}`);

    const BGM_STOP_AFTER_LOOPS = 1;

    // ===== RESUBMISSION TOGGLE (1 - able to resubmit) =====
    const RESUBMISSION_ENABLE = 0;

    // Auto-scroll delay variable (ms)
    const ARROW_AUTO_DELAY_MS = 7000;

    // (6) LIVE PHOTOS
    const PHOTOS_MANIFEST_URL = 'PHOTOS/manifest.json';
    const DRIVE_WEBAPP_URL = APPS_SCRIPT_URL + '?type=photos&v=8';
	  
    // ====== i18n strings ======
    const I18N = {
      en: {
        tagline: "Wedding Invitation",
        title: "Will you attend our wedding?",
        subtitle: "We'd love to celebrate with you. Please confirm your attendance before 1 October 2025.",
        rsvp: "YES",
        no: "NO",
        location: "Location",
        contactNav: "Contact",
        photosNav: "Photos",
        rsvpTitle: "RSVP",
        rsvpIntro: "We would be delighted for you to come and celebrate with us. Kindly confirm your attendance before 1 October 2025 by filling in your full name below:",
        fullNameFirst: "Your Full Name",
        fullNameOthers: "Attend With",
        confirm: "Confirm",
        edit: "Edit",
        phoneHeader: "CONTACT NUMBER",
        phoneHint: "We’ll use this to contact you if there are any updates or changes.",
        submit: "Submit RSVP",
        submitting: "Submitting...",
        total: (n)=>`Total: ${n} Guest(s)`,
        needPhone: "Please add your contact number.",
        needOneName: "At least one name must be confirmed before submitting.",
        nameNotConfirmed: (n)=>`Name #${n} not yet confirmed.`,
        thanks: "Thank you! Your RSVP has been received.",
        already: "RSVP already submitted. Do contact us if there are any changes.",
        thanksMore: (n)=>`Response submitted. You can still add ${n} more name(s) and resubmit if you change your mind.`,
        // EN
newConfirmedHint: (k)=> k===1
  ? "New name added — please click Submit RSVP again to include it."
  : `${k} new names added — please click Submit RSVP again to include them.`,
        duplicatePhone: "Submission Fail! - Same phone number already exists or was submitted before.",
        resubmitBlocked: "Resubmission is closed (maximum 4 guests already submitted).",

        // (1) Location text
        locTitle: "LOCATION",
        locDesc: "Tap the button below to open directions.",
        locNote: "Tip: You can share the link with friends who are carpooling.",
        locSmallHTML: `Direction to wedding avenue
(<a id="coordLink" href="#" target="_blank" rel="noopener">5.9752036,116.06877</a>)`,
        // Centered label under photo
        locHotelText: "Promanade Hotel, Kota Kinabalu",

        contactTitle: "CONTACT (Bride's Family)",
        contactDesc: "Tap the phone icon to call.",

        invSmall: "Wedding Invitation",
        invBody: "With heartfelt gratitude, we cordially invite Mr/Mdm/Mrs/Ms and your partner to our princess wedding reception.",
        invDateLabel: "Date",
        invTimeLabel: "Time",
        invVenueLabel: "Venue",
        invDressLabel: "Dress Code",
        invDressValue: "Modest",

        addrLines: [
          "Rafflesia Ballroom",
          "Promenade Hotel, 1st Floor",
          "4, 3, Lorong Api - Api 1,",
          "Api-api Centre,",
          "88000 Kota Kinabalu, Sabah."
        ],

        noMsg: "Please refresh the page if you change your mind.",

        scheduleTitle: "SCHEDULE",
        scheduleTimes: ["10:00AM","11:30AM","12:00PM","1:00PM","2:00PM","3:00PM"],
		schedItems: [
		{
			title: "GUEST ARRIVAL",
			desc: "Red carpet\nPhoto booth (10:00–12:00pm)\nGuests take their seats"
		},
		{ title: "NIKAH CEREMONY", desc: "" },
		{
			title: "WEDDING CEREMONY",
			desc: "Merenjis (blessing ritual)\nKaraoke"
		},
		{ title: "LUNCH", desc: "" },
		{ title: "PHOTO SESSION", desc: "" },
		{ title: "FAREWELL", desc: "" }
		],
        countdownTitle: "Countdown Timer",
        cdSub: "Our big day’s coming soon!",
        cdLabels: { days: "DAYS", hours: "HOURS", mins: "MINS", secs: "SECS" },

        // Photos section i18n
        liveTitle: "PHOTOS",
        liveEmpty: "No photos yet.",
        liveHelp: `Show a slideshow from a folder named “PHOTOS”.
• Easiest: put a manifest.json in /PHOTOS that lists image URLs (see code).
• Or publish a Google Apps Script Web App that returns a JSON array of public image URLs and paste it into DRIVE_WEBAPP_URL in the script.`
      },
      ms: {
        tagline: "Undangan Majlis Perkahwinan",
        title: "Adakah anda akan hadir ke majlis kami?",
        subtitle: "Kami ingin meraikan bersama anda. Mohon sahkan kehadiran anda sebelum 1 Oktober 2025.",
        rsvp: "Hadir",
        no: "Tidak Hadir",
        location: "Lokasi",
        contactNav: "Hubungi",
        photosNav: "Gambar",
        rsvpTitle: "RESPON",
        rsvpIntro: "Kami amat berbesar hati sekiranya anda hadir meraikan bersama kami. Mohon sahkan kehadiran anda sebelum 1 Oktober 2025 dengan mengisi nama penuh anda dibawah:",
        fullNameFirst: "Nama Penuh Anda",
        fullNameOthers: "Hadir Bersama",
        confirm: "Hadir",
        edit: "Ubah",
        phoneHeader: "NOMBOR UNTUK DIHUBUNGI",
        phoneHint: "Nombor untuk dihubungi jika ada makluman/perubahan.",
        submit: "Hantar Respon",
        submitting: "Menghantar...",
        total: (n)=>`Jumlah: ${n} Tetamu`,
        needPhone: "Mohon isi nombor telefon untuk dihubungi",
        needOneName: "Sekurang-kurangnya satu nama perlu disahkan hadir sebelum hantar.",
        nameNotConfirmed: (n)=>`Nama #${n} belum disahkan hadir.`,
        thanks: "Terima kasih! Respon anda telah diterima.",
        already: "RSVP telah dihantar. Sila hubungi keluarga pengantin sekiranya terdapat perubahan.",
        thanksMore: (n)=>`Respon berjaya dihantar. Anda masih boleh tambah ${n} nama lagi dan hantar semula jika berubah fikiran.`,
        // MS
newConfirmedHint: (k)=> k===1
  ? "Nama baharu telah disahkan — sila tekan Hantar Respon sekali lagi untuk masukkan ke sistem."
  : `${k} nama baharu telah disahkan — sila tekan Hantar Respon sekali lagi untuk masukkan ke sistem.`,
        duplicatePhone: "Maaf! Penghantaran dibatalkan - Nombor telefon yang sama sudah wujud atau telah dihantar sebelum ini.",
        resubmitBlocked: "Penghantaran semula ditutup (maksimum 4 tetamu telah dihantar).",

        locTitle: "LOKASI",
        locDesc: "Tekan butang dibawah untuk buka peta ke lokasi.",
        locNote: "Tip: Kongsikan pautan dengan rakan yang menumpang.",
        locSmallHTML: `Arah ke lokasi majlis
(<a id="coordLink" href="#" target="_blank" rel="noopener">5.9752036,116.06877</a>)`,
        locHotelText: "Promanade Hotel, Kota Kinabalu",

        contactTitle: "HUBUNGI (Keluarga Pengantin Perempuan)",
        contactDesc: "Tekan ikon telefon untuk membuat panggilan.",

        invSmall: "Undangan Majlis Perkahwinan",
        invBody: "Dengan penuh rasa kesyukuran, kami menjemput Dato’/Datin/Tuan/Puan/Encik/Cik beserta suami/isteri/pasangan untuk memeriahkan majlis perkahwinan puteri kami",
        invDateLabel: "Tarikh",
        invTimeLabel: "Masa",
        invVenueLabel: "Tempat",
        invDressLabel: "Etika Pakaian",
        invDressValue: "Sopan",

        addrLines: [
          "Rafflesia Ballroom",
          "Promenade Hotel, Tingkat 1",
          "4, 3, Lorong Api - Api 1,",
          "Api-api Centre,",
          "88000 Kota Kinabalu, Sabah."
        ],

        noMsg: "Sila muat semula laman ini jika berubah fikiran.",

        scheduleTitle: "ATUR CARA",
		scheduleTimes: ["10:00AM","11:30AM","12:00PM","1:00PM","2:00PM","3:00PM"],
		schedItems: [
		{
			title: "KETIBAAN PARA TETAMU",
			desc: "Red carpet\nFoto booth (10:00–12:00pm)\nTetamu mengambil tempat duduk"
		},
		{ title: "MAJLIS AKAD NIKAH", desc: "" },
		{
			title: "MAJLIS PERSANDINGAN",
			desc: "Merenjis\nKaraoke"
		},
		{ title: "JAMUAN MAKAN", desc: "" },
		{ title: "SESI BERGAMBAR", desc: "" },
		{ title: "BERSURAI", desc: "" }
		],

        countdownTitle: "KIRAAN DETIK",
        cdSub: "Hari istimewa kami semakin hampir!",
        cdLabels: { days: "HARI", hours: "JAM", mins: "MIN", secs: "SAAT" },

        liveTitle: "GAMBAR",
        liveEmpty: "Belum ada gambar.",
        liveHelp: `Paparkan slaid dari folder bernama “PHOTOS”.
• Paling mudah: letak manifest.json dalam /PHOTOS yang menyenaraikan URL imej (rujuk kod).
• Atau terbitkan Google Apps Script Web App yang memulangkan senarai URL imej umum dan tampal ke DRIVE_WEBAPP_URL dalam skrip.`
      }
    };

    // ====== DOM refs ======
    const guestRowsEl = document.getElementById('guestRows');
    const totalGuestsEl = document.getElementById('totalGuests');
    const validationMsg = document.getElementById('validationMsg');
    const submitBtn = document.getElementById('submitBtn');
let _isSubmitting = false;   // 🚦 single-click guard
    const phoneInput = document.getElementById('phone');
    const toast = document.getElementById('toast');
    const bgm = document.getElementById('bgm');

    const langToggle = document.getElementById('langToggle');
    const muteBtn = document.getElementById('muteBtn');

    const heroTag = document.getElementById('heroTag');
    const heroDate = document.getElementById('heroDate');
    const titleText = document.getElementById('titleText');
    const subtitleText = document.getElementById('subtitleText');
    const rsvpBtn = document.getElementById('rsvpBtn');
    const locationBtn = document.getElementById('locationBtn'); // may be null (legacy)
    const rsvpIntro = document.getElementById('rsvpIntro');
    const rsvpTitleEl = document.getElementById('rsvpTitle');
    const phoneHeader = document.getElementById('phoneHeader');
    const phoneHint = document.getElementById('phoneHint');
    const locTitle = document.getElementById('locTitle');
    const locDesc = document.getElementById('locDesc');
    const locNote = document.getElementById('locNote');
    const locSmall = document.getElementById('locSmall');
    const locHotel = document.getElementById('locHotel');
    const contactTitle = document.getElementById('contactTitle');
    const contactDesc = document.getElementById('contactDesc');
    const quickHome     = document.getElementById('quickHome');
    const quickLocation = document.getElementById('quickLocation');
    const quickContact  = document.getElementById('quickContact');
    const quickPhotos   = document.getElementById('quickPhotos');
    const noBtn = document.getElementById('noBtn');
    const noMsg = document.getElementById('noMsg');
    const scrollArrow = document.getElementById('scrollArrow');

    const inviteDateEl = document.getElementById('inviteDate');
    const inviteTimeEl = document.getElementById('inviteTime');
    const inviteVenueEl = document.getElementById('inviteVenue');
    const inviteDressEl = document.getElementById('inviteDress');

    const invSmall = document.getElementById('invSmall');
    const invSmall2 = document.getElementById('invSmall2');
    const invBody  = document.getElementById('invBody');
    const invDateLabel  = document.getElementById('invDateLabel');
    const invTimeLabel  = document.getElementById('invTimeLabel');
    const invVenueLabel = document.getElementById('invVenueLabel');
    const invDressLabel = document.getElementById('invDressLabel');

    const btnGmaps = document.getElementById('btnGoogleMaps');
    const btnWaze  = document.getElementById('btnWaze');

    const heroAddressEl = document.getElementById('heroAddress');
    const hotelLogoEl = document.getElementById('hotelLogo');

    // NEW refs for Schedule & Countdown i18n
    const scheduleTitleEl = document.getElementById('scheduleTitle');
    const agendaDateEl = document.getElementById('agendaDate');
    const agendaDayEl  = document.getElementById('agendaDay');
    const s1Time = document.getElementById('s1Time');
    const s2Time = document.getElementById('s2Time');
    const s3Time = document.getElementById('s3Time');
    const s4Time = document.getElementById('s4Time');
    const s5Time = document.getElementById('s5Time');
    const s1Title = document.getElementById('s1Title'); const s1Desc = document.getElementById('s1Desc');
    const s2Title = document.getElementById('s2Title'); const s2Desc = document.getElementById('s2Desc');
    const s3Title = document.getElementById('s3Title'); const s3Desc = document.getElementById('s3Desc');
    const s4Title = document.getElementById('s4Title'); const s4Desc = document.getElementById('s4Desc');
    const s4Title2 = document.getElementById('s4Title2');
    const s5Title = document.getElementById('s5Title'); const s5Desc = document.getElementById('s5Desc');
	const s6Time  = document.getElementById('s6Time');
const s6Title = document.getElementById('s6Title');
const s6Desc  = document.getElementById('s6Desc');


    const countdownTitleEl = document.getElementById('countdownTitle');
    const cdSubEl = document.getElementById('cdSub');
    const cdDaysLabel = document.getElementById('cdDaysLabel');
    const cdHoursLabel = document.getElementById('cdHoursLabel');
    const cdMinsLabel = document.getElementById('cdMinsLabel');
    const cdSecsLabel = document.getElementById('cdSecsLabel');

    // Live photos
    const liveTitleEl = document.getElementById('liveTitle');
    const liveHelpEl  = document.getElementById('liveHelp');
    const liveImg     = document.getElementById('liveImage');
    const livePrev    = document.getElementById('livePrev');
    const liveNext    = document.getElementById('liveNext');
    const liveEmpty   = document.getElementById('liveEmpty');

    const coordLink = document.getElementById('coordLink');

    // ===== New: country code refs & state =====
    const ccSelect = document.getElementById('ccSelect');
    const CC_MAP = { MY: '+60 ', IDN: '+62 ' };

    // ===== Language state =====
    let LANG = localStorage.getItem('rsvp_lang') || 'ms'; // default Malay
    function refreshLangToggleLabel(){ langToggle.textContent = (LANG === 'en') ? 'Malay' : 'English'; }

    // ===== Local state helpers =====
    function getStoredNames(){ return JSON.parse(localStorage.getItem('rsvp_names')||'[]'); }
    function getStoredConfirmed(){ return JSON.parse(localStorage.getItem('rsvp_confirmed')||'[]'); }
    function setStoredNames(arr){ localStorage.setItem('rsvp_names', JSON.stringify(arr)); }
    function setStoredConfirmed(arr){ localStorage.setItem('rsvp_confirmed', JSON.stringify(arr)); }
    function isSubmitted(){ return localStorage.getItem('rsvp_submitted') === '1'; }
    function markSubmitted(){ localStorage.setItem('rsvp_submitted','1'); }
    function getSubmittedCount(){ return parseInt(localStorage.getItem('rsvp_submitted_count') || '0', 10); }
    function setSubmittedCount(n){ localStorage.setItem('rsvp_submitted_count', String(n)); }

    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1600); }

    function getGuestInputs(){ return Array.from(document.querySelectorAll('.guest-name')); }
    function getGuestButtons(){ return Array.from(document.querySelectorAll('.guest-confirm')); }
    function getGuestNames(){ return getGuestInputs().map(i=>i.value.trim()); }
    function getConfirmedCount(){ return getGuestInputs().filter(inp => inp.readOnly && inp.value.trim().length>0).length; }
    function anyUnconfirmedTyped(){ return getGuestInputs().some(inp => !inp.readOnly && inp.value.trim().length>0); }
    function firstUnconfirmedIndexPlus1(){
      const arr = getGuestInputs();
      for(let i=0;i<arr.length;i++){
        const v = arr[i].value.trim();
        if(v && !arr[i].readOnly) return i+1;
      }
      return -1;
    }
    function updateTotals(){ const n = getGuestNames().filter(Boolean).length; totalGuestsEl.textContent = I18N[LANG].total(n); }

    function saveLocal(){
      localStorage.setItem('rsvp_phone', phoneInput.value.trim());
      localStorage.setItem('rsvp_cc', ccSelect.value);
      setStoredNames(getGuestNames());
      localStorage.setItem('rsvp_lang', LANG);
      const confirmed = getGuestInputs().map(inp => !!(inp.readOnly && inp.value.trim().length>0));
      setStoredConfirmed(confirmed);
    }

    // New: apply post-submit UI with partial resubmission allowed
    function lockSubmissionUI(){
      const T = I18N[LANG];
      const prevSubmitted = getSubmittedCount();

      // already-submitted names are locked; empty rows remain editable
      getGuestInputs().forEach((inp, idx) => {
        const hasValue = inp.value.trim().length > 0;
        const btn = getGuestButtons()[idx];
        if (hasValue){
          inp.readOnly = true;
          btn.disabled = true;
          btn.classList.remove('confirm-state'); btn.classList.add('edit-state');
          btn.textContent = T.edit;
        } else {
          inp.readOnly = false;
          btn.disabled = true;
          btn.classList.add('confirm-state'); btn.classList.remove('edit-state');
          btn.textContent = T.confirm;
        }
      });

      // phone stays locked after first submit
      phoneInput.readOnly = true;

      // messaging + submit availability
      const remaining = Math.max(0, MAX_GUESTS - prevSubmitted);
      validationMsg.style.display = 'block';
      if (remaining > 0){
        validationMsg.textContent = T.thanksMore(remaining);
      } else {
        validationMsg.textContent = T.already;
      }

      // submit enabled only when adding confirmed names and not exceeding max (handled by maybeEnableSubmit)
      maybeEnableSubmit();
    }

    function showSuccessUI(){
      // Optimistic success (immediate)
      submitBtn.disabled = true;
      submitBtn.textContent = I18N[LANG].submit;
      getGuestInputs().forEach(inp => inp.readOnly = true);
      getGuestButtons().forEach(btn => btn.disabled = true);
      phoneInput.readOnly = true;

      validationMsg.style.display = 'block';
      validationMsg.textContent = I18N[LANG].thanks;

      markSubmitted();
      saveLocal();
      showToast(I18N[LANG].thanks);
    }

    function resetFormToFreshState(){
      localStorage.removeItem('rsvp_names');
      localStorage.removeItem('rsvp_confirmed');
      localStorage.removeItem('rsvp_phone');

      renderGuestRows();
      getGuestInputs().forEach((inp, idx)=>{
        const btn = getGuestButtons()[idx];
        inp.readOnly = false;
        inp.value = '';
        btn.textContent = I18N[LANG].confirm;
        btn.classList.remove('edit-state');
        btn.classList.add('confirm-state');
        btn.disabled = true;
      });
      phoneInput.readOnly = false;
      phoneInput.value = '';
      updateTotals();
      maybeEnableSubmit();
    }

    // ===== Rendering helpers =====
    function makeGuestRow(idx){
      const T = I18N[LANG];
      const placeholder = idx===0 ? T.fullNameFirst : T.fullNameOthers;
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML =
        `<input class="input guest-name" placeholder="${placeholder}" aria-label="${placeholder}" />
         <button class="confirm-btn guest-confirm confirm-state" type="button" disabled>${T.confirm}</button>`;
      const input = row.querySelector('input');
      const btn   = row.querySelector('button');

      input.addEventListener('input', ()=>{
        btn.disabled = input.value.trim().length === 0 || input.readOnly;
        updateTotals(); saveLocal(); maybeEnableSubmit();
      });

      btn.addEventListener('click', ()=>{
        const T2 = I18N[LANG];
        if(!input.readOnly){
          if(input.value.trim().length === 0){ input.focus(); return; }
          input.readOnly = true; input.blur();
          btn.textContent = T2.edit;
          btn.classList.remove('confirm-state'); btn.classList.add('edit-state');
          btn.disabled = false;
        }else{
          // allow editing only when resubmission is permitted
          const allowEdit = (!isSubmitted()) || (getSubmittedCount() < MAX_GUESTS);
          if(!allowEdit) return;
          input.readOnly = false;
          btn.textContent = T2.confirm;
          btn.classList.remove('edit-state'); btn.classList.add('confirm-state');
          btn.disabled = input.value.trim().length === 0;
          input.focus();
        }
        saveLocal(); maybeEnableSubmit();
      });

      return row;
    }
    function renderGuestRows(){
      guestRowsEl.innerHTML = '';
      for(let i=0; i<MAX_GUESTS; i++){ guestRowsEl.appendChild(makeGuestRow(i)); }
    }

    // UPDATED: contact rows (unchanged behavior)
    function renderContacts(){
      const contactList = document.getElementById('contactList');
      if(!contactList) return;
      contactList.innerHTML = '';
      CONTACTS.forEach(c=>{
        const row = document.createElement('div');
        row.className = 'contact-row';

        const left = document.createElement('div');
        left.className = 'contact-left';
        left.textContent = c.name;

        const right = document.createElement('div');
        right.className = 'contact-right';

        const num = document.createElement('span');
        num.className = 'contact-num';
        num.textContent = c.phone;

        const call = document.createElement('a');
        call.className = 'call-btn';
        call.href = `tel:${c.phone.replace(/\s+/g,'')}`;
        call.setAttribute('aria-label', `Call ${c.name}`);
        call.innerHTML = `<img src="phone_icon.png" alt="Call ${c.name}" />`;

        right.appendChild(num);
        right.appendChild(call);

        row.appendChild(left);
        row.appendChild(right);

        contactList.appendChild(row);
      });
    }

	function renderMaps(){
	const gq = `https://www.google.com/maps/dir/?api=1&destination=${GMAPS_COORDS.lat},${GMAPS_COORDS.lng}&travelmode=driving&destination=${VENUE_LABEL}`;
	const wz = `https://waze.com/ul?ll=${WAZE_COORDS.lat}%2C${WAZE_COORDS.lng}&navigate=yes`;
	btnGmaps.href = gq; 
	btnWaze.href  = wz;
	
	// Re-select the freshly-rendered link (the old reference becomes stale after i18n)
	const coordEl = document.getElementById('coordLink');
	if (coordEl) {
		const direct = `https://www.google.com/maps/search/?api=1&query=${DISPLAY_COORDS.lat},${DISPLAY_COORDS.lng}`;
		coordEl.href = direct;
		coordEl.target = '_blank';
		coordEl.rel = 'noopener';
	}
	}


    function formatWeddingDateWithDay(lang){
      const d = new Date(`${WEDDING_DATE_ISO}T00:00:00`);
      const locale = (lang==='ms') ? 'ms-MY' : 'en-GB';
      const parts = new Intl.DateTimeFormat(locale, {
        weekday:'long', day:'2-digit', month:'long', year:'numeric'
      }).formatToParts(d);
      let out = '';
      for (let i = 0; i < parts.length; i++) {
        const p = parts[i];
        out += p.value;
        if (p.type === 'weekday') {
          const next = parts[i+1];
          const alreadyHasComma = next && next.type === 'literal' && /,/.test(next.value);
          if (!alreadyHasComma) out += ', ';
        }
      }
      return out.replace(/\s+,/g, ', ');
    }
    function formatDateOnly(lang){
      const d = new Date(`${WEDDING_DATE_ISO}T00:00:00`);
      const locale = (lang==='ms') ? 'ms-MY' : 'en-GB';
      return new Intl.DateTimeFormat(locale, { day:'2-digit', month:'long', year:'numeric' }).format(d);
    }
    function weekdayOnly(lang){
      const d = new Date(`${WEDDING_DATE_ISO}T00:00:00`);
      const locale = (lang==='ms') ? 'ms-MY' : 'en-GB';
      return new Intl.DateTimeFormat(locale, { weekday:'long' }).format(d);
    }

    /* Sync logo to address height only on wide screens to avoid mobile jitter */
    function syncLogoHeight(){
      const isWide = window.innerWidth >= 700;
      const addr = heroAddressEl;
      const img  = hotelLogoEl;
      if(!addr || !img) return;
      if(!isWide){
        img.style.height = 'auto';
        return;
      }
      requestAnimationFrame(()=>{
        const h = addr.offsetHeight || 0;
        if(h){ img.style.height = h + 'px'; }
      });
    }
    window.addEventListener('load', syncLogoHeight);
    window.addEventListener('resize', syncLogoHeight);

    // Ensure arrow offset variable applies (fix for some browsers)
    function applyArrowOffset(){
      if(!scrollArrow) return;
      scrollArrow.style.bottom = `calc(var(--arrow-bottom-offset) + var(--hero-arrow-offset-y))`;
    }
    window.addEventListener('load', applyArrowOffset);
    window.addEventListener('resize', applyArrowOffset);

    // Helper: escape HTML for safe bullet rendering
    function esc(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    // Helper: turn "line1\nline2" into bullets
    function bulletsFromText(text){
      const lines = String(text).split(/\n+/).map(l=>l.trim()).filter(Boolean);
      if(!lines.length) return '';
      return `<ul class="tl-list">${lines.map(l=>`<li>${esc(l)}</li>`).join('')}</ul>`;
    }

    function i18n(){
      const T = I18N[LANG];

      // Update shiny overlay text
      document.querySelectorAll('.couple-title .name').forEach(el=>{
        el.setAttribute('data-text', el.textContent.trim());
      });

      // Hero
      heroTag.textContent = T.tagline;
      heroDate.textContent = formatWeddingDateWithDay(LANG);

      // Address bilingual toggle — bold the first line
      if (Array.isArray(T.addrLines)) {
        heroAddressEl.innerHTML = T.addrLines
          .map((line,i)=> i===0 ? `<strong>${line}</strong>` : line)
          .join('<br/>');
      }

      // Invitation section
      invSmall.textContent = T.invSmall;
      if (invSmall2) invSmall2.textContent = 'WalimatulUrus';
      invBody.textContent = T.invBody;
      invDateLabel.textContent  = T.invDateLabel;
      invTimeLabel.textContent  = T.invTimeLabel;
      invVenueLabel.textContent = T.invVenueLabel;
      invDressLabel.textContent = T.invDressLabel;
      inviteDateEl.textContent  = formatWeddingDateWithDay(LANG);
      inviteTimeEl.textContent  = "10:30 AM – 3:00 PM";
      inviteVenueEl.textContent = "Promenade Hotel, Rafflesia Ballroom";
      inviteDressEl.textContent = T.invDressValue;

      // CTA
      titleText.textContent = T.title;
      if (subtitleText) {
        const nl = (T.subtitle || '').replace(/\.\s*/g, '.\n');
        subtitleText.textContent = nl;
      }
      if(rsvpBtn) rsvpBtn.textContent = T.rsvp;
      if(noBtn)   noBtn.textContent   = T.no;
      if(locationBtn) locationBtn.textContent = T.location;

      // Top control labels
      if(quickLocation) quickLocation.textContent = T.location;
      if(quickContact)  quickContact.textContent  = T.contactNav;
      if(quickPhotos)   quickPhotos.textContent   = T.photosNav;

      // RSVP section
      if (rsvpTitleEl) rsvpTitleEl.textContent = T.rsvpTitle;
      if(rsvpIntro)   rsvpIntro.textContent = T.rsvpIntro;
      if(phoneHeader) phoneHeader.textContent = T.phoneHeader;
      if(phoneHint)   phoneHint.textContent   = T.phoneHint;
      if(submitBtn)   submitBtn.textContent   = T.submit;

      if (noMsg){
        noMsg.textContent = T.noMsg;
        noMsg.style.display = 'none';
      }

      // Location
      locTitle.textContent = T.locTitle;
      locDesc.textContent = T.locDesc;
      if(locNote) locNote.textContent = T.locNote;
      if(locSmall) locSmall.innerHTML = T.locSmallHTML;
      if(locHotel) locHotel.textContent = T.locHotelText;

      // Contacts
      contactTitle.textContent = T.contactTitle;
      contactDesc.textContent = T.contactDesc;

      // Schedule
      if (scheduleTitleEl) scheduleTitleEl.textContent = T.scheduleTitle;
      if (agendaDateEl) agendaDateEl.textContent = formatDateOnly(LANG);
      if (agendaDayEl)  agendaDayEl.textContent  = weekdayOnly(LANG);

      const times = T.scheduleTimes || [];
      if (s1Time && times[0]) s1Time.textContent = times[0];
      if (s2Time && times[1]) s2Time.textContent = times[1];
      if (s3Time && times[2]) s3Time.textContent = times[2];
      if (s4Time && times[3]) s4Time.textContent = times[3];
      if (s5Time && times[4]) s5Time.textContent = times[4];
	  if (s6Time && times[5]) s6Time.textContent = times[5];

      const items = T.schedItems || [];
      if (items[0]){ s1Title.textContent = items[0].title; s1Desc.innerHTML = bulletsFromText(items[0].desc); }
      if (items[1]){ s2Title.textContent = items[1].title; s2Desc.innerHTML = bulletsFromText(items[1].desc); }
if (items[2]){ s3Title.textContent = items[2].title; s3Desc.innerHTML = bulletsFromText(items[2].desc); }
if (items[3]){
  s4Title.textContent  = items[3].title || '';
  if (items[3].extraTitle){
    s4Title2.style.display = '';
    s4Title2.textContent = items[3].extraTitle;
  } else {
    s4Title2.style.display = 'none';
    s4Title2.textContent = '';
  }
  s4Desc.innerHTML = bulletsFromText(items[3].desc);
}
if (items[4]){ s5Title.textContent = items[4].title; s5Desc.innerHTML = bulletsFromText(items[4].desc); }

	  if (items[5]){
		s6Title.textContent = items[5].title;
		s6Desc.innerHTML    = bulletsFromText(items[5].desc);
	}

      // Countdown
      if (countdownTitleEl) countdownTitleEl.textContent = T.countdownTitle || "Countdown";
      if (cdSubEl)          cdSubEl.textContent          = T.cdSub || "";
      if (cdDaysLabel)  cdDaysLabel.textContent  = (T.cdLabels && T.cdLabels.days)  || "DAYS";
      if (cdHoursLabel) cdHoursLabel.textContent = (T.cdLabels && T.cdLabels.hours) || "HOURS";
      if (cdMinsLabel)  cdMinsLabel.textContent  = (T.cdLabels && T.cdLabels.mins)  || "MINS";
      if (cdSecsLabel)  cdSecsLabel.textContent  = (T.cdLabels && T.cdLabels.secs)  || "SECS";

      // Photos section
      if (liveTitleEl) liveTitleEl.textContent = T.liveTitle;
      if (liveHelpEl)  liveHelpEl.innerHTML = T.liveHelp.replace(/\n/g,'<br/>');
      if (liveEmpty)   liveEmpty.textContent = T.liveEmpty;

      // Re-render guest rows with stored values
      const savedNames = getStoredNames();
      const savedConfirmed = getStoredConfirmed();
      renderGuestRows();
      getGuestInputs().forEach((inp, idx)=>{
        if(savedNames[idx]) inp.value = savedNames[idx];
        const btn = getGuestButtons()[idx];
        const isConfirmed = !!savedConfirmed[idx] && inp.value.trim().length>0;
        inp.readOnly = isConfirmed;
        btn.textContent = isConfirmed ? T.edit : T.confirm;
        btn.classList.toggle('edit-state', isConfirmed);
        btn.classList.toggle('confirm-state', !isConfirmed);
        btn.disabled = isConfirmed ? false : inp.value.trim().length === 0;
      });

      updateTotals();
      refreshLangToggleLabel();
      document.getElementById('post_lang').value = LANG;

      maybeEnableSubmit();

      if(isSubmitted()){
        // ensure we show the correct partial/full lock state
        lockSubmissionUI();
      }

      // resync heights and arrow offset
      syncLogoHeight();
      applyArrowOffset();
    }

function maybeEnableSubmit(){
    if (_isSubmitting) {
    submitBtn.disabled = true;
    return;
  }
  
  const T = I18N[LANG];

  // Start clean
  validationMsg.textContent = '';
  validationMsg.style.display = 'none';

  const submitted       = isSubmitted();
  const prevCount       = getSubmittedCount();
  const confirmedCount  = getConfirmedCount();
  const unconfIdx       = firstUnconfirmedIndexPlus1();

  // Count only unconfirmed typed names (NOT readOnly)
  const unconfirmedTypedCount = getGuestInputs()
    .filter(inp => !inp.readOnly && inp.value.trim().length > 0).length;

  // Phone rule
  const digitsAfterPrefix = phoneInput.value.replace(/^\+\d+\s*/, '').replace(/\D/g,'').length;
  const hasPhone = digitsAfterPrefix >= 6;

  const canResubmit = submitted && prevCount < MAX_GUESTS;
  const newlyConfirmed = Math.max(0, confirmedCount - prevCount);

  // Fully locked (already hit max)
  if (submitted && !canResubmit){
    submitBtn.disabled = true;
    validationMsg.style.display = 'block';
    validationMsg.textContent = T.resubmitBlocked;
    return;
  }

  // After first submit — show info & keep button grey unless new names are confirmed
  if (canResubmit){
    // nothing new typed or confirmed → keep the “thanksMore” banner, button grey
    if (newlyConfirmed === 0 && unconfirmedTypedCount === 0){
      submitBtn.disabled = true;
      validationMsg.style.display = 'block';
      validationMsg.textContent = T.thanksMore(MAX_GUESTS - prevCount);
      return;
    }

    // if at least one new name was confirmed (and no unconfirmed pending), show the resubmit hint
    if (newlyConfirmed > 0 && unconfIdx === -1 && hasPhone){
      validationMsg.style.display = 'block';
      validationMsg.textContent = T.newConfirmedHint(newlyConfirmed);
      // (do not return; we'll enable the button via `ok` below)
    }
  }

  // Validation → enable rules differ before vs after the first submit
  let ok;
  if (!submitted){
    // First submission: need at least 1 confirmed name + phone, no unconfirmed pending
    ok = hasPhone && confirmedCount >= 1 && unconfIdx === -1;
  } else {
    // After submission: only enable if there are NEW confirmed names
    ok = hasPhone && newlyConfirmed > 0 && unconfIdx === -1;
  }

  submitBtn.disabled = !ok;

  // Error / guidance messages while disabled
// Error / guidance messages while disabled (priority)
if (!ok){
  validationMsg.style.display = 'block';

  if (unconfIdx !== -1){
    // A name is typed but not confirmed
    validationMsg.textContent = T.nameNotConfirmed(unconfIdx);
  } else if (!submitted && confirmedCount < 1){
    // No confirmed names yet (first submission)
    validationMsg.textContent = T.needOneName;
  } else if (!hasPhone){
    // Phone comes after the name conditions are satisfied
    validationMsg.textContent = T.needPhone;
  } else {
    validationMsg.style.display = 'none';
  }
}
}

    // ===== Country code prefix logic (non-deletable) =====
    function currentPrefix(){ return CC_MAP[ccSelect.value] || '+60 '; }
    function ensurePrefix(){
      const pref = currentPrefix();
      if (!phoneInput.value || !phoneInput.value.startsWith(pref)){
        // replace any old prefix with the new one
        const digits = phoneInput.value.replace(/^\+\d+\s*/, '');
        phoneInput.value = pref + digits.replace(/[^\d\s]/g,'');
      }
      // place caret after prefix if it's before
      const pLen = pref.length;
      try{
        if (phoneInput.selectionStart < pLen){
          phoneInput.setSelectionRange(pLen, pLen);
        }
      }catch(_){}
    }
    function canonicalPhone(){
      // collapse spaces; keep leading + and digits only
      const v = phoneInput.value.trim().replace(/\s+/g,' ');
      const keep = v.replace(/(?!^\+)[^\d\s]/g,'');
      return keep.replace(/\s+/g,' ').trim();
    }

    ccSelect.addEventListener('change', ()=>{
      ensurePrefix();
      saveLocal();
      maybeEnableSubmit();
    });

    phoneInput.addEventListener('input', ()=>{
      ensurePrefix();
      // block typing '+' or letters after prefix
      phoneInput.value = phoneInput.value.replace(/(?!^\+)[^\d\s]/g,'');
      saveLocal(); maybeEnableSubmit();
    });
    phoneInput.addEventListener('keydown', (e)=>{
      const pref = currentPrefix();
      const pLen = pref.length;
      const pos = phoneInput.selectionStart || 0;
      if ((e.key === 'Backspace' || e.key === 'Delete') && pos <= pLen){
        e.preventDefault();
        phoneInput.setSelectionRange(pLen, pLen);
      }
    });
    function initCountryAndPhone(){
      const savedCC = localStorage.getItem('rsvp_cc');
      if (savedCC && CC_MAP[savedCC]) ccSelect.value = savedCC;
      const savedPhone = localStorage.getItem('rsvp_phone') || '';
      phoneInput.value = savedPhone || currentPrefix();
      ensurePrefix();
    }

    // Language toggle
	  langToggle.addEventListener('click', (e)=>{
	    e.preventDefault();
	    LANG = (LANG === 'en') ? 'ms' : 'en';
	    localStorage.setItem('rsvp_lang', LANG);
	    i18n();
	    renderMaps();
	    saveLocal(); 
	    maybeEnableSubmit();
	  });

    // Music
    bgm.volume = 0.2;
    function setMutedUI(){ muteBtn.textContent = bgm.muted ? '🔇' : '🔊'; }
    async function tryPlayAudible(){ try{ bgm.muted = false; await bgm.play(); setMutedUI(); return true; }catch(e){ return false; } }
    async function ensurePlayback(){
      let ok = await tryPlayAudible();
      if(ok) return;
      let tries = 0;
      const iv = setInterval(async ()=>{
        tries++;
        if(await tryPlayAudible()){ clearInterval(iv); }
        if(tries > 6){ clearInterval(iv); }
      }, 900);
      const unlock = async ()=>{
        if(await tryPlayAudible()){
          window.removeEventListener('pointerdown', unlock);
          window.removeEventListener('keydown', unlock);
          window.removeEventListener('scroll', unlock);
          window.removeEventListener('touchstart', unlock);
        }
      };
      window.addEventListener('pointerdown', unlock, { once:true });
      window.addEventListener('keydown', unlock, { once:true });
      window.addEventListener('scroll', unlock, { once:true });
      window.addEventListener('touchstart', unlock, { once:true });
    }
    window.addEventListener('pageshow', ensurePlayback);
    window.addEventListener('load', ensurePlayback);

    let _bgmLoops = 0;
    bgm.loop = false;
    bgm.addEventListener('ended', async () => {
      _bgmLoops++;
      if (_bgmLoops < BGM_STOP_AFTER_LOOPS || BGM_STOP_AFTER_LOOPS === Infinity) {
        try { bgm.currentTime = 0; await bgm.play(); } catch(_) {}
      }
    });

    muteBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{ await bgm.play(); }catch(_){}
      bgm.muted = !bgm.muted;
      setMutedUI();
    });

    // Smooth scroll (unchanged)
    function easeInOutCubic(t){ return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3)/2; }
    function smoothScrollTo(target, baseDuration=700){
      const start = window.scrollY || window.pageYOffset;
      const end = (typeof target === 'number')
        ? target
        : (target.getBoundingClientRect().top + start);
      const diff = end - start;
      const duration = Math.max(500, Math.min(1400, baseDuration + Math.abs(diff) * 0.25));
      let startTime = null;
      function step(ts){
        if(startTime === null) startTime = ts;
        const t = Math.min(1, (ts - startTime) / duration);
        const eased = easeInOutCubic(t);
        window.scrollTo(0, start + diff * eased);
        if(t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    function handleSmoothLink(link, selector){
      if(!link) return;
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        playClick();
        const el = document.querySelector(selector);
        if(el){ smoothScrollTo(el, 700); }
      });
    }

    // Handlers
    handleSmoothLink(rsvpBtn, '#rsvp');
    handleSmoothLink(locationBtn, '#location'); // legacy guard
    handleSmoothLink(quickHome, 'header.hero');
    handleSmoothLink(quickLocation, '#location');
    handleSmoothLink(quickContact,  '#contact');
    handleSmoothLink(quickPhotos,   '#live');

    // (3) Force Google login then go to Drive folder when clicking ALIPPU
    const alippuLink = document.getElementById('alippuLink');
    if (alippuLink){
      alippuLink.addEventListener('click', (e)=>{
        e.preventDefault();
        const target = (DRIVE_PRIVATE_URL && DRIVE_PRIVATE_URL.trim().length)
          ? DRIVE_PRIVATE_URL.trim()
          : 'https://drive.google.com/';
        const loginRedirect = 'https://accounts.google.com/ServiceLogin?service=wise&continue=' + encodeURIComponent(target);
        window.location.href = loginRedirect;
      });
    }

    // NO button behavior
    if(noBtn){
      noBtn.addEventListener('click', ()=>{
        noMsg.textContent = I18N[LANG].noMsg;
        noMsg.style.display = 'block';
        if (rsvpBtn){
          rsvpBtn.classList.add('disabled');
          rsvpBtn.setAttribute('aria-disabled','true');
        }
      });
    }

    // Scroll arrow behavior + delayed auto-trigger
    function scrollToCTAWithoutInvite(){
      const cta = document.querySelector('#cta');
      if(!cta){ return; }
      const invite = document.querySelector('#invite');
      const ctaTop = cta.getBoundingClientRect().top + window.scrollY;
      let target = ctaTop;
      if(invite){
        const inviteTop = invite.getBoundingClientRect().top + window.scrollY;
        const safe = Math.max(0, inviteTop - (window.innerHeight - 20));
        target = Math.min(ctaTop, safe);
      }
      smoothScrollTo(target, 700);
    }
    if(scrollArrow){
      scrollArrow.addEventListener('click', (e)=>{
        e.preventDefault();
        playClick();
        scrollToCTAWithoutInvite();
      });
    }
    (function autoArrow(){
      let moved = false;
      const mark = ()=>{ moved = true; };
      ['wheel','touchstart','scroll','keydown','pointerdown'].forEach(ev=>{
        window.addEventListener(ev, mark, { once:true, passive:true });
      });
      setTimeout(()=>{
        if(!moved && (window.scrollY||window.pageYOffset) < 8){
          scrollArrow && scrollArrow.click();
        }
      }, ARROW_AUTO_DELAY_MS);
    })();

    // Click sounds
    let audioCtx;
    function initAudioCtx(){ if(!audioCtx){ const AC = window.AudioContext || window.webkitAudioContext; audioCtx = new AC(); } }
    function playTone(freq=660, ms=60, type='sine', volume=0.05){
      initAudioCtx();
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = volume;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + ms/1000);
      o.stop(audioCtx.currentTime + ms/1000 + 0.02);
    }
    function playClick(){ playTone(660, 50, 'sine', 0.05); }
    function playError(){ playTone(220, 120, 'sine', 0.06); }
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('button, a'); if(!el) return;
      const isDisabled = el.matches('button[disabled], .disabled') || el.getAttribute('aria-disabled') === 'true';
      if(isDisabled){ e.preventDefault(); playError(); return; }
      if(el.tagName === 'A' && el.getAttribute('href') === '#'){ e.preventDefault(); }
      playClick();
    }, true);

    // ===== Duplicate phone check (Apps Script) =====
    async function phoneExistsOnServer(phone){
      try{
        const url = `${APPS_SCRIPT_URL}?type=check_phone&phone=${encodeURIComponent(phone)}`;
        const r = await fetch(url, { cache:'no-store' });
        if(!r.ok) return false; // fail open if endpoint not present
        const data = await r.json();
        return !!(data && data.exists);
      }catch(_){
        return false; // fail open
      }
    }

    // Render
    function renderAll(){
      i18n();
      renderContacts();
      renderMaps();

      initCountryAndPhone();

      const names = getStoredNames();
      const conf  = getStoredConfirmed();
      getGuestInputs().forEach((inp, idx)=>{
        if(names[idx]) inp.value = names[idx];
        const btn = getGuestButtons()[idx];
        const isConfirmed = !!conf[idx] && inp.value.trim().length>0;
        inp.readOnly = isConfirmed;
        btn.textContent = isConfirmed ? I18N[LANG].edit : I18N[LANG].confirm;
        btn.classList.toggle('edit-state', isConfirmed);
        btn.classList.toggle('confirm-state', !isConfirmed);
        btn.disabled = isConfirmed ? false : inp.value.trim().length === 0;
      });
      updateTotals();
      refreshLangToggleLabel();

      if(isSubmitted()){
        // ensure locked/partial-locked after reload
        lockSubmissionUI();
      } else {
        phoneInput.readOnly = false;
        phoneInput.value = localStorage.getItem('rsvp_phone') || phoneInput.value;
        maybeEnableSubmit();
      }

      syncLogoHeight();
      applyArrowOffset();
    }
    renderAll();

    phoneInput.addEventListener('input', ()=>{ saveLocal(); maybeEnableSubmit(); });

    // ===== (1) Loading helpers for submit button =====
    function startBtnLoading(btn){ btn.classList.add('loading'); btn.disabled = true; }
    function stopBtnLoading(btn){ btn.classList.remove('loading'); }

    // Submit to Apps Script (iframe) with pre-check
    const form = document.getElementById('rsvpForm');
    const hiddenIframe = document.getElementById('hidden_iframe');
    form.action = APPS_SCRIPT_URL;

    function syncHiddenFields(){
      const names = getGuestNames();
      document.getElementById('post_guest1').value = names[0]||'';
      document.getElementById('post_guest2').value = names[1]||'';
      document.getElementById('post_guest3').value = names[2]||'';
      document.getElementById('post_guest4').value = names[3]||'';
      document.getElementById('post_count').value = names.filter(Boolean).length;
      document.getElementById('post_ua').value = navigator.userAgent;
      document.getElementById('post_lang').value = LANG;
    }

    let _pendingSubmit = false;
    hiddenIframe.addEventListener('load', ()=>{
      if(!_pendingSubmit) return;
      _pendingSubmit = false;
      _isSubmitting = false;
      stopBtnLoading(submitBtn);                 // ← stop spinner
      submitBtn.textContent = I18N[LANG].submit; // ← revert label
      showToast(I18N[LANG].thanks);

      // Update submission counters and UI (show "respon berjaya dihantar..." / "...ditutup")
      markSubmitted();
      const nowCount = getConfirmedCount();
      setSubmittedCount(nowCount);
      saveLocal();
      lockSubmissionUI();
      updateTotals();
    });

async function attemptSubmit(){
  const T = I18N[LANG];

  // already submitting? ignore extra clicks
  if (_isSubmitting) return;
  _isSubmitting = true;

  // start loading animation (show dots), hide message while sending
  startBtnLoading(submitBtn);
  submitBtn.textContent = T.submitting; // label hidden by .loading
  validationMsg.style.display = 'none';

  // --- re-submit guards (same logic, but now they also clear the guard) ---
  const prevCount     = getSubmittedCount();
  const currConfirmed = getConfirmedCount();

  if (isSubmitted() && prevCount < MAX_GUESTS && currConfirmed <= prevCount){
    stopBtnLoading(submitBtn);
    validationMsg.style.display = 'block';
    validationMsg.textContent = T.thanksMore(MAX_GUESTS - prevCount);
    submitBtn.textContent = T.submit;
    _isSubmitting = false;
    playError();
    return;
  }

  if (isSubmitted() && getSubmittedCount() >= MAX_GUESTS){
    stopBtnLoading(submitBtn);
    validationMsg.style.display = 'block';
    validationMsg.textContent = T.resubmitBlocked;
    submitBtn.textContent = T.submit;
    _isSubmitting = false;
    return;
  }

  // --- duplicate phone check (allow same device resubmits) ---
  const canon = canonicalPhone();
  const exists = await phoneExistsOnServer(canon);
  const sameDevice = isSubmitted();

  if (exists && !sameDevice){
    stopBtnLoading(submitBtn);
    validationMsg.style.display = 'block';
    validationMsg.textContent = T.duplicatePhone;
    submitBtn.textContent = T.submit;
    _isSubmitting = false;
    playError();
    return;
  }

  // --- proceed with real submit ---
  syncHiddenFields();
  saveLocal();
  _pendingSubmit = true;

  // Post to iframe (keep spinner on until iframe loads)
  form.submit();
}

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // standard client-side conditions
      if(submitBtn.disabled){ playError(); return; }
      await attemptSubmit();
    });

    // Particles (unchanged)
    (function initParticles(){
      const canvas = document.getElementById('bg-particles');
      const ctx = canvas.getContext('2d');
      if(!canvas || !ctx) return;
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(prefersReduced) return;

      let w, h, particles=[], last=0, running=true;
      function resize(){ w = canvas.width = innerWidth; h = canvas.height = innerHeight; }
      resize(); addEventListener('resize', resize);

      const count = Math.min(90, Math.max(55, Math.floor((w*h)/32000)));
      const palettes = [
        { inner:'rgba(255,255,255,0.9)', outer:'rgba(255,255,255,0.0)' },
        { inner:'rgba(255,240,210,0.85)', outer:'rgba(255,240,210,0.0)' },
        { inner:'rgba(240,210,120,0.85)', outer:'rgba(240,210,120,0.0)' },
        { inner:'rgba(212,175,55,0.85)',  outer:'rgba(212,175,55,0.0)'  },
        { inner:'rgba(184,144,23,0.85)',  outer:'rgba(184,144,23,0.0)'  }
      ];

      for(let i=0;i<count;i++){
        const p = palettes[(Math.random()*palettes.length)|0];
        particles.push({
          x: Math.random()*w, y: Math.random()*h,
          r: 1 + Math.random()*4 + (Math.random()<0.12?2:0),
          s: 12 + Math.random()*34,
          drift: (Math.random()*0.8 - 0.4),
          inner: p.inner, outer: p.outer,
          pulse: 0.85 + Math.random()*0.3,
        });
      }

      function step(ts){
        if(!last) last = ts;
        const dt = Math.min(0.033, (ts - last)/1000); last = ts;

        ctx.clearRect(0,0,w,h);
        ctx.globalCompositeOperation = 'lighter';
        for(const p of particles){
          p.y -= p.s * dt;
          p.x += p.drift * dt * 60;
          if(p.y < -10){ p.y = h + 10; p.x = Math.random()*w; }

          const rr = p.r * (p.pulse + Math.sin((ts/600)+(p.x+p.y))*0.03);
          const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, rr*2.2);
          g.addColorStop(0, p.inner);
          g.addColorStop(0.5, p.inner);
          g.addColorStop(1, p.outer);

          ctx.fillStyle = g;
          ctx.beginPath(); ctx.arc(p.x, p.y, rr, 0, Math.PI*2); ctx.fill();
        }
        if(running) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);

      document.addEventListener('visibilitychange',()=>{
        running=!document.hidden;
        if(running){ last=0; requestAnimationFrame(step); }
      });
    })();

    // Countdown
    (function initCountdown(){
      const dEl = document.getElementById('cdDays');
      const hEl = document.getElementById('cdHours');
      const mEl = document.getElementById('cdMins');
      const sEl = document.getElementById('cdSecs');

      function pad(n){ return String(n); }
      function tick(){
        const now = new Date();
        let diff = Math.max(0, COUNTDOWN_TARGET.getTime() - now.getTime());

        const days = Math.floor(diff / (1000*60*60*24)); diff -= days*(1000*60*60*24);
        const hrs  = Math.floor(diff / (1000*60*60));     diff -= hrs *(1000*60*60);
        const mins = Math.floor(diff / (1000*60));        diff -= mins*(1000*60);
        const secs = Math.floor(diff / 1000);

        dEl.textContent = pad(days);
        hEl.textContent = pad(hrs);
        mEl.textContent = pad(mins);
        sEl.textContent = pad(secs);
      }
      tick(); setInterval(tick, 1000);
    })();

    // Orientation wallpaper fallback
    (function ensureWallpaperOnRotate(){
      const m = window.matchMedia('(orientation: portrait)');
      function apply(){
        const url = m.matches ? "url('rsvpwallpaper_mob.png')" : "url('rsvpwallpaper_web.png')";
        document.documentElement.style.setProperty('--wallpaper', url);
      }
      apply();
      if (m.addEventListener) m.addEventListener('change', apply);
      else if (m.addListener) m.addListener(apply);
      window.addEventListener('orientationchange', apply);
      window.addEventListener('resize', apply);
    })();

    // ===== (6) LIVE PHOTOS loader =====
    let LIVE_PHOTOS = []; // array of image URLs
    let liveIndex = 0;

    function showLivePhoto(){
      if (!LIVE_PHOTOS.length){
        liveImg.style.display = 'none';
        liveEmpty.style.display = 'block';
        return;
      }
      liveEmpty.style.display = 'none';
      liveImg.style.display = 'block';
      liveImg.src = LIVE_PHOTOS[liveIndex];
    }

    function nextPhoto(){ if (!LIVE_PHOTOS.length) return; liveIndex = (liveIndex + 1) % LIVE_PHOTOS.length; showLivePhoto(); }
    function prevPhoto(){ if (!LIVE_PHOTOS.length) return; liveIndex = (liveIndex - 1 + LIVE_PHOTOS.length) % LIVE_PHOTOS.length; showLivePhoto(); }

    liveNext.addEventListener('click', nextPhoto);
    livePrev.addEventListener('click', prevPhoto);

    async function tryFetchJSON(url){
      try{
        const r = await fetch(url, { cache: 'no-store' });
        if(!r.ok) return null;
        return await r.json();
      }catch(_){ return null; }
    }

    async function loadLivePhotos(){
      // Priority 1: local manifest /PHOTOS/manifest.json
      let arr = await tryFetchJSON(PHOTOS_MANIFEST_URL);
      if (Array.isArray(arr) && arr.length){
        LIVE_PHOTOS = arr.filter(u=>typeof u === 'string');
        showLivePhoto();
        return;
      }
      // Priority 2: Apps Script web app
      if (DRIVE_WEBAPP_URL){
        arr = await tryFetchJSON(DRIVE_WEBAPP_URL);
        if (Array.isArray(arr) && arr.length){
          LIVE_PHOTOS = arr.filter(u=>typeof u === 'string');
          showLivePhoto();
          return;
        }
      }
      // Nothing found
      LIVE_PHOTOS = [];
      showLivePhoto();
    }
    loadLivePhotos();
  </script>
</body>
</html>