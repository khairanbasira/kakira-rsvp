<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kak Ira Wedding RSVP</title>
  <meta name="description" content="RSVP for Kak Ira's wedding â€” elegant, mobile-first, bilingual (EN/MS)." />
  <meta name="theme-color" content="#fff7ec" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Palette */
      --gold:#d4af37;
      --gold-strong:#b89017;     /* darker gold for borders/active */
      --gold-soft:#fff0c9;       /* light gold fill for confirm */
      --gold-soft-2:#f6e7b8;     /* pale gold tint */
      --cream:#fff7ec;           /* page background */
      --white:#ffffff;
      --text:#1f2937;            /* cool dark text */
      --muted:#6b7280;

      /* UI */
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --shadow-sm:0 6px 16px rgba(0,0,0,.08);

      /* Hero wallpaper */
      --wallpaper:url('wallpaper.jpg');

      /* Overlay tuning (lower = more visible photo) */
      --hero-overlay-color: 255,247,236; /* warm cream RGB */
      --hero-overlay-1: .35;  /* top opacity */
      --hero-overlay-2: .50;  /* middle opacity */
      --hero-overlay-3: .65;  /* bottom opacity */
    }

    *{ box-sizing:border-box }
    html{ scroll-behavior:auto } /* custom easing via JS */
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--cream);
    }

    /* Background particles */
    #bg-particles{
      position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.35;
    }

    /* Top-right minimalist controls */
    .top-controls{
      position:fixed; top:15px; right:15px;
      display:flex; gap:10px; z-index:9999;
    }
    .icon-btn{
      appearance:none; cursor:pointer;
      background:#fff; color:#5a3d00;
      border:1px solid rgba(0,0,0,.06);
      padding:8px 12px; border-radius:999px;
      font-size:14px; font-weight:600;
      box-shadow:var(--shadow-sm);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .icon-btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }
    .icon-btn:active{ transform:translateY(0); }

    /* Volume popover (appears under mute button) */
    .volume-pop{
      position:fixed; z-index:9998; display:none;
      background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px;
      box-shadow:var(--shadow); padding:10px 10px 12px; width:56px;
    }
    .volume-pop.show{ display:block; }
    .vol-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    .vol-slider-wrap{ width:28px; height:140px; position:relative; }
    .vol-slider{
      appearance:none; position:absolute; top:0; left:0;
      width:140px; height:28px; transform-origin:left top; transform:rotate(-90deg);
      outline:none; background:transparent;
    }
    .vol-slider::-webkit-slider-thumb{
      appearance:none; width:16px; height:16px; border-radius:50%;
      background:var(--gold); border:1px solid var(--gold-strong);
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }
    .vol-slider::-webkit-slider-runnable-track{
      height:6px; background:linear-gradient(#eee,#eee);
      border-radius:999px; border:1px solid #ddd;
    }
    .vol-btn{
      width:32px; height:32px; border-radius:999px;
      display:grid; place-items:center; cursor:pointer;
      border:1px solid var(--gold-strong); background:#fff; color:#111;
      box-shadow:var(--shadow-sm); font-weight:700;
    }

    /* Hero with adjustable overlay */
    .hero{
      position:relative; z-index:1;
      min-height:72vh;
      display:grid; place-items:center; text-align:center; color:#222;
      background:
        linear-gradient(
          180deg,
          rgba(var(--hero-overlay-color), var(--hero-overlay-1)) 0%,
          rgba(var(--hero-overlay-color), var(--hero-overlay-2)) 55%,
          rgba(var(--hero-overlay-color), var(--hero-overlay-3)) 100%
        ),
        var(--wallpaper) center/cover no-repeat fixed;
    }
    .heading{ font-family:'Playfair Display',serif; font-size:clamp(28px,5vw,52px); line-height:1.12; }
    .sub{ color:var(--muted); margin-top:8px }

    /* Buttons */
    .cta-row{ margin-top:26px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    .btn{
      appearance:none; cursor:pointer; display:inline-block; text-decoration:none;
      padding:14px 22px; border-radius:var(--radius);
      background:#fff; color:#111; font-weight:600; letter-spacing:.3px;
      border:1px solid var(--gold-strong);
      box-shadow:var(--shadow-sm);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }
    .btn:active{ transform:translateY(0); }
    .btn-outline{ background:#fff; color:#111; border:1px solid var(--gold-strong) }

    /* Submit button */
    #submitBtn{
      background:var(--gold); color:#111; border:1px solid var(--gold-strong);
    }
    #submitBtn[disabled]{
      background:#eee; color:#999; border-color:#ddd; cursor:not-allowed;
      box-shadow:none; transform:none;
    }

    section{ padding:58px 16px; background:transparent; }
    .container{ max-width:980px; margin:0 auto; }
    .card{
      background:#fff; border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:22px;
    }

    /* Guest rows: input (1fr) + button (auto) */
    .grid{ display:grid; gap:14px; grid-template-columns:1fr; }
    .row{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }

    /* Inputs */
    .input{
      width:100%; padding:14px 16px; border-radius:12px;
      border:1px solid #e5e7eb; font-size:16px; background:#fff;
      transition:border-color .12s ease, box-shadow .12s ease, background .12s ease;
      outline:none;
    }
    .input::placeholder{ color:#c8c8c8; opacity:1; }
    .input:focus:not([readonly]){
      border-color:var(--gold-strong);
      box-shadow:0 0 0 3px rgba(212,175,55,.20);
    }
    .input[readonly]{
      background:#fffdf7;
      border-color:#ead79a;
      color:#6b4b00;
    }

    .tiny{ font-size:12px; color:var(--muted) }
    .total{ text-align:center; margin-top:6px; color:#374151 }

    /* Confirm/Edit pill */
    .confirm-btn{
      white-space:nowrap; border-radius:12px; padding:10px 14px;
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--gold-strong);
      box-shadow:var(--shadow-sm);
      transition:opacity .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
      cursor:pointer;
    }
    .confirm-btn.confirm-state{ background:var(--gold-soft); color:#111; }
    .confirm-btn.edit-state{ background:#fff; color:#111; }
    .confirm-btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .submit-wrap{ display:flex; flex-direction:column; gap:12px; }

    /* Notice (validation) */
    .notice{
      background:#fff; border:1px solid #fde68a;
      padding:12px 14px; border-radius:12px; color:#92400e;
      box-shadow:var(--shadow-sm);
    }
    .muted{ color:var(--muted) }

    /* Subtle gold separator + spacers */
    .separator{
      height:1px; margin:18px 0;
      background:linear-gradient(90deg, transparent, rgba(184,144,23,.35), transparent);
    }
    .spacer-8{ height:8px }
    .spacer-16{ height:16px }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; }
    .footer{ text-align:center; color:#6b7280; padding:30px 16px 70px; background:transparent; }

    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#111; color:#fff; padding:12px 16px; border-radius:12px;
      opacity:0; pointer-events:none; transition:.25s ease;
      box-shadow:0 8px 24px rgba(0,0,0,.3)
    }
    .toast.show{ opacity:1 }
  </style>
</head>
<body>

  <!-- Particles -->
  <canvas id="bg-particles" aria-hidden="true"></canvas>

  <!-- Top-right controls -->
  <div class="top-controls">
    <button id="langToggle" class="icon-btn" aria-label="Toggle language">Malay</button>
    <button id="muteBtn" class="icon-btn" aria-label="Toggle sound">ðŸ”Š</button>
  </div>

  <!-- Volume popover -->
  <div id="volumePop" class="volume-pop" role="dialog" aria-label="Volume">
    <div class="vol-wrap">
      <div class="vol-slider-wrap">
        <input id="volumeSlider" class="vol-slider" type="range" min="1" max="100" step="1" value="20" aria-label="Volume slider">
      </div>
      <button id="volPlus" class="vol-btn" type="button">+</button>
      <button id="volMinus" class="vol-btn" type="button">âˆ’</button>
    </div>
  </div>

  <header class="hero">
    <div>
      <!-- Basran â™¡ Khairani -->
      <div class="heading" id="titleText">Will you attend our wedding?</div>
      <div class="sub" id="subtitleText">We'd love to celebrate with you. Please RSVP below.</div>
      <div class="cta-row">
        <a class="btn" href="#rsvp" id="rsvpBtn" data-smooth>RSVP</a>
        <a class="btn btn-outline" href="#location" id="locationBtn" data-smooth>Location</a>
      </div>
    </div>
  </header>

  <main>
    <section id="rsvp">
      <div class="container">
        <div class="card">
          <h2 style="margin:0 0 8px;font-family:'Playfair Display',serif">RSVP</h2>
          <p class="muted" id="rsvpIntro">Please add up to four guest names and your main contact number.</p>

          <form id="rsvpForm" method="POST" target="hidden_iframe">
            <!-- NOTE: backend expects guest1..guest4; MAX_GUESTS should stay â‰¤ 4 unless backend updated -->
            <input type="hidden" name="guest1" id="post_guest1">
            <input type="hidden" name="guest2" id="post_guest2">
            <input type="hidden" name="guest3" id="post_guest3">
            <input type="hidden" name="guest4" id="post_guest4">
            <input type="hidden" name="lang" id="post_lang" value="en">
            <input type="hidden" name="guestsCount" id="post_count" value="0">
            <input type="hidden" name="ua" id="post_ua">
            <input type="hidden" name="note" id="post_note">

            <!-- Guest names -->
            <div id="guestRows" class="grid" aria-live="polite"></div>

            <!-- Phone section separated from names -->
            <div class="separator"></div>
            <div class="spacer-8"></div>

            <div class="submit-wrap">
              <div>
                <label for="phone" class="tiny" id="phoneLabel">Main contact number *</label>
                <input class="input" id="phone" name="phone" autocomplete="tel" placeholder="e.g. +60 12 345 6789" required />
              </div>

              <!-- separator before error + submit -->
              <div class="spacer-16"></div>
              <div class="separator"></div>

              <!-- Error ABOVE submit (no extra spacer above error) -->
              <div class="notice tiny" id="validationMsg" style="display:none" aria-live="polite"></div>

              <!-- Small space between error and submit -->
              <div class="spacer-8"></div>
              <button class="btn" id="submitBtn" type="submit" disabled>Submit RSVP</button>

              <!-- Totals -->
              <div class="tiny total" id="totalGuests">Total: 0 guest(s)</div>
            </div>
          </form>
          <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>
        </div>
      </div>
    </section>

    <section id="location">
      <div class="container">
        <div class="card">
          <h2 style="margin:0 0 8px;font-family:'Playfair Display',serif" id="locTitle">Location & Directions</h2>
          <p class="muted" id="locDesc">Tap a button below to open directions.</p>
          <div class="actions" style="margin:10px 0 18px">
            <a class="btn" id="btnGoogleMaps" target="_blank" rel="noopener">Google Maps</a>
            <a class="btn btn-outline" id="btnWaze" target="_blank" rel="noopener">Waze</a>
          </div>
          <div class="muted tiny" id="locNote">Tip: You can share the link with friends who are carpooling.</div>
        </div>
      </div>
    </section>

    <section id="contact">
      <div class="container">
        <div class="card">
          <h2 style="margin:0 0 8px;font-family:'Playfair Display',serif" id="contactTitle">Contact (Bride's family)</h2>
          <p class="muted" id="contactDesc">Tap a name to call directly.</p>
          <div id="contactList" class="actions" style="margin-top:6px"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="tiny">Made with â™¥ for Kak Ira</div>
  </footer>

  <div id="toast" class="toast">Saved!</div>

  <!-- Background music -->
  <audio id="bgm" src="maulaya.mp3" autoplay loop preload="auto" playsinline></audio>

  <script>
    // ====== CONFIG ======
    const MAX_GUESTS = 4; // keep â‰¤ 4 unless Apps Script is updated to accept more guestN fields
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxbWUzpJp8IH7eIJ4PorTtVFEJK9npyGY8HR6o0HfaNj9_Adin081iRrvof4V_LVMs/exec";
    const GMAPS_COORDS = { lat: 5.975194, lng: 116.0688396 };
    const WAZE_COORDS  = { lat: 5.975194, lng: 116.0688396 };
    const VENUE_LABEL  = encodeURIComponent("Kak Ira Wedding Venue");
    const CONTACTS = [
      { name: "Muhammad Basri", phone: "+60 12 345 6789" },
      { name: "Samsah Suda", phone: "+60 13 222 1111" },
      { name: "Anyone", phone: "+60 19 121 2121" },
    ];

    // ====== i18n strings ======
    const I18N = {
      en: {
        title: "Will you attend our wedding?",
        subtitle: "We'd love to celebrate with you. Please RSVP below.",
        rsvp: "RSVP",
        location: "Location",
        rsvpIntro: "Please add up to four guest names and your main contact number.",
        fullNameFirst: "Your Full Name",
        fullNameOthers: "Attend with",
        confirm: "Confirm",
        edit: "Edit",
        phoneLabel: "Main contact number *",
        submit: "Submit RSVP",
        total: (n)=>`Total: ${n} guest(s)`,
        needPhone: "Please add your contact number.",
        needOneName: "At least one name must be confirmed before submitting.",
        thanks: "Thank you! Your RSVP has been received.",
        already: "RSVP already submitted. Editing is disabled.",
        locTitle: "Location & Directions",
        locDesc: "Tap a button below to open directions.",
        locNote: "Tip: You can share the link with friends who are carpooling.",
        contactTitle: "Contact (Bride's family)",
        contactDesc: "Tap a name to call directly.",
      },
      ms: {
        title: "Adakah anda akan hadir ke majlis kami?",
        subtitle: "Jemput RSVP di bawah ya.",
        rsvp: "RSVP",
        location: "Lokasi",
        rsvpIntro: "Sila isi sehingga empat nama tetamu dan nombor telefon utama.",
        fullNameFirst: "Nama Penuh Anda",
        fullNameOthers: "Hadir bersama",
        confirm: "Sahkan",
        edit: "Ubah",
        phoneLabel: "Nombor telefon utama *",
        submit: "Hantar RSVP",
        total: (n)=>`Jumlah: ${n} tetamu`,
        needPhone: "Sila isi nombor telefon.",
        needOneName: "Sekurang-kurangnya satu nama perlu disahkan sebelum hantar.",
        thanks: "Terima kasih! RSVP anda telah diterima.",
        already: "RSVP telah dihantar. Penyuntingan dimatikan.",
        locTitle: "Lokasi & Arah",
        locDesc: "Tekan butang untuk buka arah ke lokasi.",
        locNote: "Tip: Kongsikan pautan dengan rakan yang menumpang.",
        contactTitle: "Hubungi (keluarga pengantin perempuan)",
        contactDesc: "Tekan nama untuk terus membuat panggilan.",
      }
    };

    // ====== DOM refs ======
    const guestRowsEl = document.getElementById('guestRows');
    const totalGuestsEl = document.getElementById('totalGuests');
    const validationMsg = document.getElementById('validationMsg');
    const submitBtn = document.getElementById('submitBtn');
    const phoneInput = document.getElementById('phone');
    const toast = document.getElementById('toast');
    const bgm = document.getElementById('bgm');

    // Controls
    const langToggle = document.getElementById('langToggle');
    const muteBtn = document.getElementById('muteBtn');

    // Top texts
    const titleText = document.getElementById('titleText');
    const subtitleText = document.getElementById('subtitleText');
    const rsvpBtn = document.getElementById('rsvpBtn');
    const locationBtn = document.getElementById('locationBtn');
    const rsvpIntro = document.getElementById('rsvpIntro');
    const phoneLabel = document.getElementById('phoneLabel');
    const locTitle = document.getElementById('locTitle');
    const locDesc = document.getElementById('locDesc');
    const locNote = document.getElementById('locNote');
    const contactTitle = document.getElementById('contactTitle');
    const contactDesc = document.getElementById('contactDesc');

    // Map buttons
    const btnGmaps = document.getElementById('btnGoogleMaps');
    const btnWaze  = document.getElementById('btnWaze');

    // Volume popover
    const volumePop = document.getElementById('volumePop');
    const volumeSlider = document.getElementById('volumeSlider');
    const volPlus = document.getElementById('volPlus');
    const volMinus = document.getElementById('volMinus');

    // ===== Language state =====
    let LANG = localStorage.getItem('rsvp_lang') || 'en';
    function refreshLangToggleLabel(){
      langToggle.textContent = (LANG === 'en') ? 'Malay' : 'English';
    }

    // ===== Local state for confirmation & submission lock =====
    function getStoredNames(){ return JSON.parse(localStorage.getItem('rsvp_names')||'[]'); }
    function getStoredConfirmed(){ return JSON.parse(localStorage.getItem('rsvp_confirmed')||'[]'); }
    function setStoredNames(arr){ localStorage.setItem('rsvp_names', JSON.stringify(arr)); }
    function setStoredConfirmed(arr){ localStorage.setItem('rsvp_confirmed', JSON.stringify(arr)); }
    function isSubmitted(){ return localStorage.getItem('rsvp_submitted') === '1'; }
    function markSubmitted(){ localStorage.setItem('rsvp_submitted','1'); }

    // ===== Helpers =====
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1600);
    }

    function getGuestInputs(){ return Array.from(document.querySelectorAll('.guest-name')); }
    function getGuestButtons(){ return Array.from(document.querySelectorAll('.guest-confirm')); }
    function getGuestNames(){ return getGuestInputs().map(i=>i.value.trim()); }
    function getConfirmedCount(){ return getGuestInputs().filter(inp => inp.readOnly && inp.value.trim().length>0).length; }
    function anyUnconfirmedTyped(){ return getGuestInputs().some(inp => !inp.readOnly && inp.value.trim().length>0); }

    function updateTotals(){
      const n = getGuestNames().filter(Boolean).length;
      totalGuestsEl.textContent = I18N[LANG].total(n);
    }

    function saveLocal(){
      localStorage.setItem('rsvp_phone', phoneInput.value.trim());
      setStoredNames(getGuestNames());
      localStorage.setItem('rsvp_lang', LANG);
      const confirmed = getGuestInputs().map(inp => !!(inp.readOnly && inp.value.trim().length>0));
      setStoredConfirmed(confirmed);
    }

    function lockSubmissionUI(){
      // Lock all inputs/buttons permanently until cache cleared
      getGuestInputs().forEach(inp => { inp.readOnly = true; });
      getGuestButtons().forEach(btn => { btn.disabled = true; btn.classList.remove('confirm-state'); btn.classList.add('edit-state'); });
      phoneInput.readOnly = true;
      submitBtn.disabled = true;
      validationMsg.style.display = 'block';
      validationMsg.textContent = I18N[LANG].already;
    }

    function loadLocal(){
      const phone = localStorage.getItem('rsvp_phone') || '';
      const names = getStoredNames();
      const confirmed = getStoredConfirmed();

      phoneInput.value = phone;

      getGuestInputs().forEach((inp, idx)=>{
        if(names[idx]) inp.value = names[idx];
        const btn = getGuestButtons()[idx];
        const isConfirmed = !!confirmed[idx] && inp.value.trim().length>0;
        inp.readOnly = isConfirmed;
        btn.textContent = isConfirmed ? I18N[LANG].edit : I18N[LANG].confirm;
        btn.classList.toggle('edit-state', isConfirmed);
        btn.classList.toggle('confirm-state', !isConfirmed);
        btn.disabled = isConfirmed ? false : inp.value.trim().length === 0;
      });

      updateTotals();
      maybeEnableSubmit();

      if(isSubmitted()){
        lockSubmissionUI();
      }
    }

    function makeGuestRow(idx){
      const T = I18N[LANG];
      const placeholder = idx===0 ? T.fullNameFirst : T.fullNameOthers;
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <input class="input guest-name" placeholder="${placeholder}" aria-label="${placeholder}" />
        <button class="confirm-btn guest-confirm confirm-state" type="button" disabled>${T.confirm}</button>
      `;
      const input = row.querySelector('input');
      const btn   = row.querySelector('button');

      input.addEventListener('input', ()=>{
        btn.disabled = input.value.trim().length === 0 || input.readOnly;
        updateTotals(); saveLocal(); maybeEnableSubmit();
      });

      btn.addEventListener('click', ()=>{
        const T = I18N[LANG];
        if(!input.readOnly){
          if(input.value.trim().length === 0){ input.focus(); return; }
          input.readOnly = true;
          input.blur();
          btn.textContent = T.edit;
          btn.classList.remove('confirm-state');
          btn.classList.add('edit-state');
          btn.disabled = false;
        }else{
          // Even if user taps Edit, if already submitted we keep it locked
          if(isSubmitted()){
            return;
          }
          input.readOnly = false;
          btn.textContent = T.confirm;
          btn.classList.remove('edit-state');
          btn.classList.add('confirm-state');
          btn.disabled = input.value.trim().length === 0;
          input.focus();
        }
        saveLocal(); maybeEnableSubmit();
      });

      return row;
    }

    function renderGuestRows(){
      guestRowsEl.innerHTML = '';
      for(let i=0; i<MAX_GUESTS; i++){
        guestRowsEl.appendChild(makeGuestRow(i));
      }
    }

    function renderContacts(){
      const contactList = document.getElementById('contactList');
      if(!contactList) return;
      contactList.innerHTML = '';
      CONTACTS.forEach(c=>{
        const a = document.createElement('a');
        a.className = 'btn btn-outline';
        a.href = `tel:${c.phone.replace(/\s+/g,'')}`;
        a.textContent = `${c.name} (${c.phone})`;
        contactList.appendChild(a);
      });
    }

    function renderMaps(){
      const gq = `https://www.google.com/maps/dir/?api=1&destination=${GMAPS_COORDS.lat},${GMAPS_COORDS.lng}&travelmode=driving&destination=${VENUE_LABEL}`;
      const wz = `https://waze.com/ul?ll=${WAZE_COORDS.lat}%2C${WAZE_COORDS.lng}&navigate=yes`;
      btnGmaps.href = gq; btnWaze.href = wz;
    }

    function i18n(){
      const T = I18N[LANG];
      // top texts
      titleText.textContent = T.title;
      subtitleText.textContent = T.subtitle;
      rsvpBtn.textContent = T.rsvp;
      locationBtn.textContent = T.location;
      rsvpIntro.textContent = T.rsvpIntro;
      phoneLabel.textContent = T.phoneLabel;
      submitBtn.textContent = (LANG === 'en' ? 'Submit RSVP' : 'Hantar RSVP');
      locTitle.textContent = T.locTitle;
      locDesc.textContent = T.locDesc;
      locNote.textContent = T.locNote;
      contactTitle.textContent = T.contactTitle;
      contactDesc.textContent = T.contactDesc;

      // rebuild rows to refresh placeholders, then restore saved states
      const savedNames = getStoredNames();
      const savedConfirmed = getStoredConfirmed();
      renderGuestRows();
      getGuestInputs().forEach((inp, idx)=>{
        if(savedNames[idx]) inp.value = savedNames[idx];
        const btn = getGuestButtons()[idx];
        const isConfirmed = !!savedConfirmed[idx] && inp.value.trim().length>0;
        inp.readOnly = isConfirmed;
        btn.textContent = isConfirmed ? T.edit : T.confirm;
        btn.classList.toggle('edit-state', isConfirmed);
        btn.classList.toggle('confirm-state', !isConfirmed);
        btn.disabled = isConfirmed ? false : inp.value.trim().length === 0;
      });

      updateTotals();
      refreshLangToggleLabel();
      document.getElementById('post_lang').value = LANG;

      // Make sure validation/lock message flips language too
      maybeEnableSubmit();
      if(isSubmitted()){
        lockSubmissionUI();
      }
    }

    function maybeEnableSubmit(){
      if(isSubmitted()){ submitBtn.disabled = true; return; }
      const hasPhone = phoneInput.value.trim().length > 0;
      const confirmedCount = getConfirmedCount();
      const hasUnconfirmedTyped = anyUnconfirmedTyped();

      const ok = hasPhone && confirmedCount >= 1 && !hasUnconfirmedTyped;
      submitBtn.disabled = !ok;

      const T = I18N[LANG];
      validationMsg.style.display = (!ok) ? 'block' : 'none';
      if(!hasPhone){
        validationMsg.textContent = T.needPhone;
      }else if(confirmedCount < 1){
        validationMsg.textContent = T.needOneName;
      }else if(hasUnconfirmedTyped){
        validationMsg.textContent = T.needOneName;
      }else{
        validationMsg.textContent = '';
      }
    }

    // ===== Language toggle =====
    langToggle.addEventListener('click', (e)=>{
      e.preventDefault();
      LANG = (LANG === 'en') ? 'ms' : 'en';
      localStorage.setItem('rsvp_lang', LANG);
      i18n(); saveLocal(); maybeEnableSubmit();
    });

    // ===== Music: audible autoplay + volume 20% =====
    bgm.volume = 0.2;
    function setMutedUI(){ muteBtn.textContent = bgm.muted ? 'ðŸ”‡' : 'ðŸ”Š'; }
    async function tryPlayAudible(){
      try{ bgm.muted = false; await bgm.play(); setMutedUI(); return true; }catch(e){ return false; }
    }
    async function ensurePlayback(){
      let ok = await tryPlayAudible();
      if(ok) return;
      let tries = 0;
      const iv = setInterval(async ()=>{
        tries++;
        if(await tryPlayAudible()){ clearInterval(iv); }
        if(tries > 6){ clearInterval(iv); }
      }, 900);
      const unlock = async ()=>{
        if(await tryPlayAudible()){
          window.removeEventListener('pointerdown', unlock);
          window.removeEventListener('keydown', unlock);
          window.removeEventListener('scroll', unlock);
          window.removeEventListener('touchstart', unlock);
        }
      };
      window.addEventListener('pointerdown', unlock, { once:true });
      window.addEventListener('keydown', unlock, { once:true });
      window.addEventListener('scroll', unlock, { once:true });
      window.addEventListener('touchstart', unlock, { once:true });
    }
    window.addEventListener('pageshow', ensurePlayback);
    window.addEventListener('load', ensurePlayback);

    muteBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{ await bgm.play(); }catch(_){}
      bgm.muted = !bgm.muted;
      setMutedUI();
      // also show volume pop on click
      showVolumePop();
    });

    // ===== Smooth scrolling with ease-in/out =====
    function easeInOutQuad(t){ return t<0.5 ? 2*t*t : -1+(4-2*t)*t; }
    function smoothScrollTo(target, duration=700){
      const start = window.scrollY || window.pageYOffset;
      const end = (typeof target === 'number') ? target : (target.getBoundingClientRect().top + start);
      const diff = end - start;
      let startTime = null;
      function step(ts){
        if(startTime === null) startTime = ts;
        const t = Math.min(1, (ts - startTime) / duration);
        const eased = easeInOutQuad(t);
        window.scrollTo(0, start + diff * eased);
        if(t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    function handleSmoothLink(link, selector){
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        playClick();
        const el = document.querySelector(selector);
        if(el){ smoothScrollTo(el, 750); }
      });
    }
    handleSmoothLink(rsvpBtn, '#rsvp');
    handleSmoothLink(locationBtn, '#location');

    // ===== Subtle click/error sounds (WebAudio) =====
    let audioCtx;
    function initAudioCtx(){
      if(!audioCtx){
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
      }
    }
    function playTone(freq=660, ms=60, type='sine', volume=0.05){
      initAudioCtx();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = volume;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + ms/1000);
      o.stop(audioCtx.currentTime + ms/1000 + 0.02);
    }
    function playClick(){ playTone(660, 50, 'sine', 0.05); }
    function playError(){ playTone(220, 120, 'sine', 0.06); }

    document.addEventListener('click', (e)=>{
      const el = e.target.closest('button, a');
      if(!el) return;
      const isDisabled = el.matches('button[disabled], .disabled') || el.getAttribute('aria-disabled') === 'true';
      if(isDisabled){
        e.preventDefault();
        playError();
        return;
      }
      if(el.tagName === 'A' && el.getAttribute('href') === '#'){ e.preventDefault(); }
      playClick();
    }, true);

    // ===== Volume popover behaviour =====
    let hidePopTimer;
    function positionVolumePop(){
      const r = muteBtn.getBoundingClientRect();
      const top = r.bottom + 8; // show below the button
      const left = r.right - 56; // align right edges
      volumePop.style.top = `${top}px`;
      volumePop.style.left = `${left}px`;
    }
    function showVolumePop(){
      positionVolumePop();
      volumePop.classList.add('show');
      clearTimeout(hidePopTimer);
    }
    function hideVolumePop(){
      hidePopTimer = setTimeout(()=>volumePop.classList.remove('show'), 150);
    }
    muteBtn.addEventListener('mouseenter', showVolumePop);
    muteBtn.addEventListener('mouseleave', hideVolumePop);
    volumePop.addEventListener('mouseenter', ()=>clearTimeout(hidePopTimer));
    volumePop.addEventListener('mouseleave', hideVolumePop);
    window.addEventListener('scroll', ()=>{ if(volumePop.classList.contains('show')) positionVolumePop(); });
    window.addEventListener('resize', ()=>{ if(volumePop.classList.contains('show')) positionVolumePop(); });

    function applyVolumeFromSlider(){
      const v = Math.max(1, Math.min(100, parseInt(volumeSlider.value || '20', 10)));
      bgm.volume = v / 100;
    }
    volumeSlider.addEventListener('input', applyVolumeFromSlider);
    function adjustVolume(delta){
      let v = parseInt(volumeSlider.value || '20', 10);
      v = Math.max(1, Math.min(100, v + delta));
      volumeSlider.value = String(v);
      applyVolumeFromSlider();
    }
    volPlus.addEventListener('click', ()=>adjustVolume(+10));
    volMinus.addEventListener('click', ()=>adjustVolume(-10));

    // ===== Render (order matters) =====
    function renderContacts(){
      const contactList = document.getElementById('contactList');
      if(!contactList) return;
      contactList.innerHTML = '';
      CONTACTS.forEach(c=>{
        const a = document.createElement('a');
        a.className = 'btn btn-outline';
        a.href = `tel:${c.phone.replace(/\s+/g,'')}`;
        a.textContent = `${c.name} (${c.phone})`;
        contactList.appendChild(a);
      });
    }
    function renderMaps(){
      const gq = `https://www.google.com/maps/dir/?api=1&destination=${GMAPS_COORDS.lat},${GMAPS_COORDS.lng}&travelmode=driving&destination=${VENUE_LABEL}`;
      const wz = `https://waze.com/ul?ll=${WAZE_COORDS.lat}%2C${WAZE_COORDS.lng}&navigate=yes`;
      btnGmaps.href = gq; btnWaze.href = wz;
    }

    function renderAll(){
      i18n();
      renderContacts();
      renderMaps();

      const names = getStoredNames();
      const conf  = getStoredConfirmed();
      getGuestInputs().forEach((inp, idx)=>{
        if(names[idx]) inp.value = names[idx];
        const btn = getGuestButtons()[idx];
        const isConfirmed = !!conf[idx] && inp.value.trim().length>0;
        inp.readOnly = isConfirmed;
        btn.textContent = isConfirmed ? I18N[LANG].edit : I18N[LANG].confirm;
        btn.classList.toggle('edit-state', isConfirmed);
        btn.classList.toggle('confirm-state', !isConfirmed);
        btn.disabled = isConfirmed ? false : inp.value.trim().length === 0;
      });
      updateTotals();
      refreshLangToggleLabel();
      phoneInput.value = localStorage.getItem('rsvp_phone') || '';
      if(isSubmitted()) lockSubmissionUI();
      else maybeEnableSubmit();

      // Volume UI initial
      volumeSlider.value = String(Math.round(bgm.volume * 100) || 20);
    }

    renderAll();

    phoneInput.addEventListener('input', ()=>{ saveLocal(); maybeEnableSubmit(); });

    // ===== Submit to Google Apps Script (hidden iframe) =====
    const form = document.getElementById('rsvpForm');
    const hiddenIframe = document.getElementById('hidden_iframe');
    form.action = APPS_SCRIPT_URL;

    function syncHiddenFields(){
      const names = getGuestNames();
      document.getElementById('post_guest1').value = names[0]||'';
      document.getElementById('post_guest2').value = names[1]||'';
      document.getElementById('post_guest3').value = names[2]||'';
      document.getElementById('post_guest4').value = names[3]||'';
      document.getElementById('post_count').value = names.filter(Boolean).length;
      document.getElementById('post_ua').value = navigator.userAgent;
      document.getElementById('post_lang').value = LANG;
    }

    let _pendingSubmit = false;

    hiddenIframe.addEventListener('load', ()=>{
      // Only handle the load that follows a form submission
      if(!_pendingSubmit) return;
      _pendingSubmit = false;

      showToast(I18N[LANG].thanks);
      markSubmitted();
      lockSubmissionUI();
      saveLocal();
      updateTotals();
    });

    form.addEventListener('submit', (e)=>{
      // Disallow resubmit if already submitted
      if(isSubmitted() || submitBtn.disabled){
        e.preventDefault();
        playError();
        return;
      }
      syncHiddenFields();
      saveLocal();
      _pendingSubmit = true; // the next iframe load is our submission response
      // posts to iframe
    });

    // ===== Particle animation (subtle gold bubbles) =====
    (function initParticles(){
      const canvas = document.getElementById('bg-particles');
      const ctx = canvas.getContext('2d');
      if(!canvas || !ctx) return;

      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(prefersReduced) return;

      let w, h, particles=[], last=0, running=true;
      function resize(){ w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
      resize(); window.addEventListener('resize', resize);

      const colorPool = [
        'rgba(212,175,55,0.20)',
        'rgba(184,144,23,0.18)',
        'rgba(240,210,120,0.16)'
      ];
      const count = Math.min(80, Math.max(40, Math.floor((window.innerWidth*window.innerHeight)/60000)));
      for(let i=0;i<count;i++){
        particles.push({
          x: Math.random()*w,
          y: Math.random()*h,
          r: 1 + Math.random()*3,
          s: 10 + Math.random()*30,   // speed px/s
          c: colorPool[Math.floor(Math.random()*colorPool.length)],
          drift: (Math.random()*0.6 - 0.3) // slight horizontal drift
        });
      }

      function step(ts){
        if(!last) last = ts;
        const dt = Math.min(0.033, (ts - last)/1000);
        last = ts;

        ctx.clearRect(0,0,w,h);
        ctx.globalCompositeOperation = 'lighter';
        for(const p of particles){
          p.y -= p.s * dt;
          p.x += p.drift;
          if(p.y < -10){ p.y = h + 10; p.x = Math.random()*w; }
          ctx.beginPath();
          ctx.fillStyle = p.c;
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fill();
        }
        if(running) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);

      document.addEventListener('visibilitychange', ()=>{
        running = !document.hidden;
        if(running){ last=0; requestAnimationFrame(step); }
      });
    })();
  </script>
</body>
</html>
